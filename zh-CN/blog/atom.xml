<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://www.geek66.cyou/zh-CN/blog</id>
    <title>Xiangcheng Kuo Blog</title>
    <updated>2024-04-11T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://www.geek66.cyou/zh-CN/blog"/>
    <subtitle>Xiangcheng Kuo Blog</subtitle>
    <icon>https://www.geek66.cyou/zh-CN/https://github.com/orange-guo.png</icon>
    <entry>
        <title type="html"><![CDATA[在GitLab的CI/CD中支持Go Module引用同一代码库下的其他Go仓库]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2024/04/11/support-gomod-referencing-local-repos-in-gitlab-cicd</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2024/04/11/support-gomod-referencing-local-repos-in-gitlab-cicd"/>
        <updated>2024-04-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[在Golang中, 代码复用的实现方式是通过git方式引用代码.]]></summary>
        <content type="html"><![CDATA[<p>在<code>Golang</code>中, 代码复用的实现方式是通过<code>git</code>方式引用代码.<br>
如果在<code>CI/CD</code>中引用同一代码库下的其他<code>Go</code>仓库, 由于<code>Gitlab</code>对仓库的访问权限限制, 还需要执行一些配置来确保<code>go mod</code>
能够正确下载依赖项.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="操作步骤">操作步骤<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/11/support-gomod-referencing-local-repos-in-gitlab-cicd#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4" class="hash-link" aria-label="操作步骤的直接链接" title="操作步骤的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="设置goprivate环境变量">设置<code>GOPRIVATE</code>环境变量<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/11/support-gomod-referencing-local-repos-in-gitlab-cicd#%E8%AE%BE%E7%BD%AEgoprivate%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" class="hash-link" aria-label="设置goprivate环境变量的直接链接" title="设置goprivate环境变量的直接链接">​</a></h3>
<p>设置<code>GOPRIVATE</code>变量</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export GOPRIVATE=${CI_SERVER_HOST}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的<code>${CI_SERVER_HOST}</code>是gitlab代码库的域名.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用git-config的insteadof指令替换原始的https请求并添加认证信息">使用<code>git config</code>的<code>insteadOf</code>指令替换原始的<code>https</code>请求并添加认证信息<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/11/support-gomod-referencing-local-repos-in-gitlab-cicd#%E4%BD%BF%E7%94%A8git-config%E7%9A%84insteadof%E6%8C%87%E4%BB%A4%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%A7%8B%E7%9A%84https%E8%AF%B7%E6%B1%82%E5%B9%B6%E6%B7%BB%E5%8A%A0%E8%AE%A4%E8%AF%81%E4%BF%A1%E6%81%AF" class="hash-link" aria-label="使用git-config的insteadof指令替换原始的https请求并添加认证信息的直接链接" title="使用git-config的insteadof指令替换原始的https请求并添加认证信息的直接链接">​</a></h3>
<p><code>go mod</code>通过<code>git</code>下载依赖项.<br>
对于私有的git仓库, 如果不进行认证, 将会出现错误.<br></p>
<p>使用下述命令替换原始的<code>https</code>请求并添加认证信息</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}".insteadOf "https://${CI_SERVER_HOST}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述<code>insteadOf</code>指令为原始的<code>https</code>请求添加了认证信息.<br>
认证凭证来自于<code>CI_JOB_TOKEN</code>, 这是CI/CD生命周期中自动生成的.<br></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置被依赖的仓库允许其他项目通过ci_job_token进行访问">配置被依赖的仓库允许其他项目通过<code>CI_JOB_TOKEN</code>进行访问<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/11/support-gomod-referencing-local-repos-in-gitlab-cicd#%E9%85%8D%E7%BD%AE%E8%A2%AB%E4%BE%9D%E8%B5%96%E7%9A%84%E4%BB%93%E5%BA%93%E5%85%81%E8%AE%B8%E5%85%B6%E4%BB%96%E9%A1%B9%E7%9B%AE%E9%80%9A%E8%BF%87ci_job_token%E8%BF%9B%E8%A1%8C%E8%AE%BF%E9%97%AE" class="hash-link" aria-label="配置被依赖的仓库允许其他项目通过ci_job_token进行访问的直接链接" title="配置被依赖的仓库允许其他项目通过ci_job_token进行访问的直接链接">​</a></h3>
<p>在<code>GitLab</code>中进入被依赖的仓库, 在<code>Settings &gt; CI/CD &gt; Token Access</code>中配置允许其他项目通过<code>CI_JOB_TOKEN</code>进行访问。</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[升级spring-cloud-gateway到4.1.0的过程中遇到的问题的以及对应解决方案]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2024/04/08/troubleshooting-and-solutions-encountered-during-the-upgrade-process-of-spring-cloud-gateway-to-version-4.1.0</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2024/04/08/troubleshooting-and-solutions-encountered-during-the-upgrade-process-of-spring-cloud-gateway-to-version-4.1.0"/>
        <updated>2024-04-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[此文记录了升级spring-cloud-gateway到4.1.0的过程中遇到的问题以及对应的解决方案.]]></summary>
        <content type="html"><![CDATA[<p>此文记录了升级spring-cloud-gateway到4.1.0的过程中遇到的问题以及对应的解决方案.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="springcloudgatewayroutes中定义的转发规则失效-提示404-not_found-no-static-resource-xxx"><code>spring.cloud.gateway.routes</code>中定义的转发规则失效, 提示<code>404 NOT_FOUND "No static resource xxx."</code><a href="https://www.geek66.cyou/zh-CN/blog/2024/04/08/troubleshooting-and-solutions-encountered-during-the-upgrade-process-of-spring-cloud-gateway-to-version-4.1.0#springcloudgatewayroutes%E4%B8%AD%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99%E5%A4%B1%E6%95%88-%E6%8F%90%E7%A4%BA404-not_found-no-static-resource-xxx" class="hash-link" aria-label="springcloudgatewayroutes中定义的转发规则失效-提示404-not_found-no-static-resource-xxx的直接链接" title="springcloudgatewayroutes中定义的转发规则失效-提示404-not_found-no-static-resource-xxx的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/08/troubleshooting-and-solutions-encountered-during-the-upgrade-process-of-spring-cloud-gateway-to-version-4.1.0#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h3>
<p>这个问题的原因是项目中的类继承了<code>org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</code>
但是新版本不兼容导致的.<br>
在新版本中<code>RoutePredicateHandlerMapping</code>的<code>@Bean</code>定义增加了<code>@ConditionalOnMissingBean</code>.<br></p>
<blockquote>
<p>定义位于<code>org.springframework.cloud.gateway.config.GatewayAutoConfiguration</code>中.<br>
<code>RoutePredicateHandlerMapping</code>是<code>HandlerMapping</code>的实现, 对于注册到容器中的<code>HandlerMapping</code>, <code>spring-mvc-reactive</code>
会自动调用这些类的方法来尝试处理请求.</p>
</blockquote>
<p>由于多出了<code>@ConditionalOnMissingBean</code>这会导致框架内置的和自定义的<code>RoutePredicateHandlerMapping</code>出现互斥的问题, 即只会被注册一次.</p>
<p>但是由于重写的方法只实现了部分自定义的转发规则, 从而导致<code>spring.cloud.gateway.routes</code>中定义的转发规则失效.</p>
<p>3.0.2中的Bean定义如下:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RoutePredicateHandlerMapping</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">routePredicateHandlerMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">FilteringWebHandler</span><span class="token plain"> webHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">																 </span><span class="token class-name">RouteLocator</span><span class="token plain"> routeLocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">GlobalCorsProperties</span><span class="token plain"> globalCorsProperties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Environment</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RoutePredicateHandlerMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">webHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> routeLocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalCorsProperties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3.4.0中的Bean定义如下:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@ConditionalOnMissingBean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RoutePredicateHandlerMapping</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">routePredicateHandlerMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">FilteringWebHandler</span><span class="token plain"> webHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">																 </span><span class="token class-name">RouteLocator</span><span class="token plain"> routeLocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">GlobalCorsProperties</span><span class="token plain"> globalCorsProperties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Environment</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RoutePredicateHandlerMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">webHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> routeLocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalCorsProperties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/08/troubleshooting-and-solutions-encountered-during-the-upgrade-process-of-spring-cloud-gateway-to-version-4.1.0#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3>
<p>修改继承类重写的<code>protected Mono&lt;Route&gt; lookupRoute(ServerWebExchange exchange)</code>方法的实现, 先调用父类的方法, 如果父类方法返回为空,
则执行自定义的转发规则以确保<code>spring.cloud.gateway.routes</code>中定义的转发规则生效.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Route</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lookupRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ServerWebExchange</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lookupRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">switchIfEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Mono</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">defer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// 此处为自定义的转发规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="spring" term="spring"/>
        <category label="spring-cloud" term="spring-cloud"/>
        <category label="spring-cloud-gateway" term="spring-cloud-gateway"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[升级grafana过程中遇到的问题的以及对应修复方案]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2024/04/07/upgrading-grafana-issues-and-fixes</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2024/04/07/upgrading-grafana-issues-and-fixes"/>
        <updated>2024-04-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[访问grafana报错403 origin not allowed]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="访问grafana报错403-origin-not-allowed">访问grafana报错403 origin not allowed<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/07/upgrading-grafana-issues-and-fixes#%E8%AE%BF%E9%97%AEgrafana%E6%8A%A5%E9%94%99403-origin-not-allowed" class="hash-link" aria-label="访问grafana报错403 origin not allowed的直接链接" title="访问grafana报错403 origin not allowed的直接链接">​</a></h2>
<p>这个issue<a href="https://github.com/grafana/grafana/issues/45117" target="_blank" rel="noopener noreferrer">Unable to Create/Save Dashboard after v8.3.5 Update</a>
提到了403问题的解决方案, 这个问题是grafana新版本引入了<code>breaking change</code>, 如果请求的<code>host</code>
和配置中的<code>server.domian</code>不匹配, 则会返回403.<br></p>
<p>这个问题通常是<code>reverse proxy</code>的问题, <code>reverse proxy</code>转发时会丢失原始的客户端请求的<code>host</code>信息, 传递的<code>host</code>
信息为<code>reverse proxy</code>代理规则中对应的<code>host</code>信息(通常是内网的hostname).</p>
<p>解决方案是修改<code>reverse proxy</code>的配置, 在转发时将<code>host</code>替换为<code>grafana</code>中配置的<code>server.domain</code>即可</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dashboard中依赖的panel组件过时">dashboard中依赖的panel组件过时<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/07/upgrading-grafana-issues-and-fixes#dashboard%E4%B8%AD%E4%BE%9D%E8%B5%96%E7%9A%84panel%E7%BB%84%E4%BB%B6%E8%BF%87%E6%97%B6" class="hash-link" aria-label="dashboard中依赖的panel组件过时的直接链接" title="dashboard中依赖的panel组件过时的直接链接">​</a></h2>
<p>当<code>dashboard</code>中依赖的<code>panel</code>过时时, panel上会有警告图标提示需要更新, 解决方案是在<code>Dashboard</code>管理界面中点击<code>panel</code>
的<code>edit</code>按钮, 替换为最新的<code>panel</code>组件, 然后保存<code>dashboard</code>即可.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="https://www.geek66.cyou/zh-CN/blog/2024/04/07/upgrading-grafana-issues-and-fixes#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/#cookie_samesite" target="_blank" rel="noopener noreferrer">Configure Grafana</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="grafana" term="grafana"/>
        <category label="component-upgrade" term="component-upgrade"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Gnome桌面环境启用Wayland]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland"/>
        <updated>2024-03-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[默认情况下, Gnome桌面环境使用的协议是X11协议.]]></summary>
        <content type="html"><![CDATA[<p>默认情况下, Gnome桌面环境使用的协议是<code>X11</code>协议. <br>
<code>Wayland</code>是<code>X11</code>的替代品, 可以提供更好的性能和体验.(绘图在Client侧而不是像<code>X11</code>一样由<code>XServer</code>负责).<br>
下面将介绍如何启用<code>Wayland</code>协议.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="确认当前的通信协议">确认当前的通信协议<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland#%E7%A1%AE%E8%AE%A4%E5%BD%93%E5%89%8D%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE" class="hash-link" aria-label="确认当前的通信协议的直接链接" title="确认当前的通信协议的直接链接">​</a></h2>
<p>执行以下命令, 确认当前的通信协议:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo $XDG_SESSION_TYPE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当输出结果为<code>x11</code>时, 说明当前使用的是<code>X11</code>协议.
如果输出结果为<code>wayland</code>时, 说明当前使用的是<code>Wayland</code>协议, 不需要做任何操作.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="修改配置文件">修改配置文件<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" class="hash-link" aria-label="修改配置文件的直接链接" title="修改配置文件的直接链接">​</a></h2>
<p>执行以下命令, 修改配置文件:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo vim /etc/gdm3/custom.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将配置文件中的<code>WaylandEnable=false</code>改为<code>WaylandEnable=true</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="重启gdm服务并进入桌面">重启gdm服务并进入桌面<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland#%E9%87%8D%E5%90%AFgdm%E6%9C%8D%E5%8A%A1%E5%B9%B6%E8%BF%9B%E5%85%A5%E6%A1%8C%E9%9D%A2" class="hash-link" aria-label="重启gdm服务并进入桌面的直接链接" title="重启gdm服务并进入桌面的直接链接">​</a></h2>
<p>执行以下命令, 重启gdm服务:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart gdm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当<code>gdm</code>服务重启后, 当前登录的会话会退出, 需要重新登录, 登录时选择<code>Wayland</code>登录方式即可.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证">验证<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland#%E9%AA%8C%E8%AF%81" class="hash-link" aria-label="验证的直接链接" title="验证的直接链接">​</a></h2>
<p>执行以下命令, 验证是否启用Wayland:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo $XDG_SESSION_TYPE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当输出结果为<code>wayland</code>时, 说明启用Wayland成功.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://linuxconfig.org/how-to-enable-disable-wayland-on-ubuntu-22-04-desktop" target="_blank" rel="noopener noreferrer">How to enable/disable wayland on Ubuntu 22.04 Desktop</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="update-2023-03-28">Update 2023-03-28<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/27/gnome-desktop-environment-enabling-wayland#update-2023-03-28" class="hash-link" aria-label="Update 2023-03-28的直接链接" title="Update 2023-03-28的直接链接">​</a></h2>
<p>在使用了一段时间后, 发现部分应用对<code>Wayland</code>的支持不足.<br>
例如<code>InteiliJ IDEA</code>, 其底层基于<code>Java</code>的<code>Swing</code>实现图形渲染, 但是目前<code>Swing</code>还是基于<code>X11</code>协议, 因此无法使用<code>Wayland</code>协议,
会导致系统使用<code>XWayland</code>来模拟<code>X11</code>协议, 从而影响其性能,
主要的影响是打字输入的渲染会比较卡顿以及应用内部窗口初始化时会出现短暂的黑色背景.<br></p>
<p><code>Jetbrains</code>去年发布过一个博客, 该博客详细介绍了基于<code>IDE</code>对<code>Wayland</code>的支持.<br>
<a href="https://blog.jetbrains.com/platform/2023/08/wayland-support/" target="_blank" rel="noopener noreferrer">Wayland Support for IntelliJ-based IDEs</a><br>
该博客中首先对<code>Wayland</code>作出了介绍, 以及目前<code>Java</code>对<code>Wayland</code>的支持现状由于历史的原因, <code>Java</code>尚未支持<code>Wayland</code>而是采用<code>Xwayland</code>兼容性过渡方案.<br>
其次介绍了目前对于<code>Java</code>原生<code>Wayland</code>支持的挑战.<br>
最后是对未来支持<code>Wayland</code>的展望.<br>
该博客中提到了目前<code>OpenJDK</code>中的<code>Wakefield</code>项目致力于解决让在<code>JDK</code>中实现<code>Wayland display server</code>的支持<br></p>
<p><strong>该项目有中短期和中长期两个目标:</strong></p>
<blockquote>
<p>短期到中期解决方案:<br>
a short to medium term solution for JDK running on Wayland in X11 compatibility mode.<br>
JDK在X11兼容模式下运行在Wayland上.<br></p>
</blockquote>
<blockquote>
<p>中期到长期解决方案:<br>
a medium to long term solution for JDK running as a native Wayland client. Pure Wayland toolkit plan proposal.<br>
JDK作为原生Wayland客户端, 需要一个纯Wayland工具包方案.<br></p>
</blockquote>
<p>更多信息参考:</p>
<ul>
<li><a href="https://wiki.openjdk.org/display/wakefield" target="_blank" rel="noopener noreferrer">OpenJDK Project Wakefield - Wayland desktop support for JDK on Linux</a></li>
<li><a href="https://cr.openjdk.org/~prr/javaone/2022/wakefield/wakefield_bof.pdf" target="_blank" rel="noopener noreferrer">Project Wakefield: A New Wayland Desktop for Java On Linux</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="linux" term="linux"/>
        <category label="wayland" term="wayland"/>
        <category label="gnome" term="gnome"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[使用apache-httpclient5并通过DNS请求服务如果域名不符合FQDN规范导致报错NullPointerException的问题的排查及修复]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2024/03/15/troubleshooting-and-fixing-null-pointer-exception-when-using-apache-httpclient5-for-dns-requests-for-services-with-non-compliant-fqdn</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2024/03/15/troubleshooting-and-fixing-null-pointer-exception-when-using-apache-httpclient5-for-dns-requests-for-services-with-non-compliant-fqdn"/>
        <updated>2024-03-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[此问题是升级apache-httpclient5过程中遇到的问题.]]></summary>
        <content type="html"><![CDATA[<p>此问题是升级apache-httpclient5过程中遇到的问题.<br></p>
<p>项目是多租户场景, 每个租户都有自己的服务, 所有服务部署在<code>kubernetes</code>上.<br>
每个租户的服务在独立的<code>namespace</code>中 <code>namespace</code>是租户的<code>ID</code>(例如<code>1663783236729442304</code>)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="现象">现象<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/15/troubleshooting-and-fixing-null-pointer-exception-when-using-apache-httpclient5-for-dns-requests-for-services-with-non-compliant-fqdn#%E7%8E%B0%E8%B1%A1" class="hash-link" aria-label="现象的直接链接" title="现象的直接链接">​</a></h3>
<p>业务服务通过<code>feign</code>(底层采用<code>httpclient5</code>)调用租户服务时报错, 错误日志如下:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.NullPointerException: Host name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.base/java.util.Objects.requireNonNull(Objects.java:259)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.apache.hc.core5.util.Args.notNull(Args.java:169)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.apache.hc.core5.util.Args.containsNoBlanks(Args.java:88)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.apache.hc.core5.http.HttpHost.&lt;init&gt;(HttpHost.java:84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.apache.hc.core5.http.HttpHost.&lt;init&gt;(HttpHost.java:104)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.apache.hc.core5.http.HttpHost.create(HttpHost.java:168)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at feign.hc5.ApacheHttp5Client.execute(ApacheHttp5Client.java:84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at feign.micrometer.MicrometerObservationCapability.lambda$enrich$1(MicrometerObservationCapability.java:53)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:70)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at feign.ReflectiveFeign$FeignInvocationHandler.invoke(ReflectiveFeign.java:99)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="原因">原因<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/15/troubleshooting-and-fixing-null-pointer-exception-when-using-apache-httpclient5-for-dns-requests-for-services-with-non-compliant-fqdn#%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="原因的直接链接" title="原因的直接链接">​</a></h3>
<p>访问租户服务时, 通过<code>DNS</code>请求服务, 格式为<code>&lt;service-name&gt;.&lt;tenant-id&gt;</code>.<br>
上述格式组成的域名不符合<code>FQDN</code>规范(以<code>.</code>进行分割的列表最后部分的内容为<code>&lt;tenant-id&gt;</code>, 必须以字母开头)</p>
<p><code>httpclient5</code>内部解析<code>URI</code>时使用的是<code>java.net.URI#create</code>方法进行解析,
由于<code>hostname</code>部分不符合规范,
会导致返回的<code>URI</code>对象获取的<code>host</code>值为<code>null</code>, 从而导致出现<code>NullPointerException</code></p>
<p>例如上述代码</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> URI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"http://servicea.1663783236729442304/api/v1/tasks"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其控制台输出为<code>null</code></p>
<p><code>URI</code>内部解析hostname代码如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// hostname      = domainlabel [ "." ] | 1*( domainlabel "." ) toplabel [ "." ]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// domainlabel   = alphanum | alphanum *( alphanum | "-" ) alphanum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// toplabel      = alpha | alpha *( alphanum | "-" ) alphanum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parseHostname</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> skipParseException</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">URISyntaxException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> l </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// Start of last parsed label</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// domainlabel = alphanum [ *( alphanum | "-" ) alphanum ]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		q </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">L_ALPHANUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">H_ALPHANUM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		l </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		q </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">L_ALPHANUM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">L_DASH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">H_ALPHANUM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">H_DASH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">charAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token char">'-'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token function" style="color:#d73a49">fail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Illegal character in hostname"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> q </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		q </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">'.'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">':'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skipParseException</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">fail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Illegal character in hostname"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">failExpecting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"hostname"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// for a fully qualified hostname check that the rightmost</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// label starts with an alpha character.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> start </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">charAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">L_ALPHA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">H_ALPHA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">fail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Illegal character in hostname"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">substring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码中可以看到如下注释</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// for a fully qualified hostname check that the rightmost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// label starts with an alpha character.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在<code>RFC 1035</code>中对<code>Domain names</code>进行了规范
其中第<code>2.3.1</code>有相关定义</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;domain&gt; ::= &lt;subdomain&gt; | " "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;subdomain&gt; ::= &lt;label&gt; | &lt;subdomain&gt; "." &lt;label&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;label&gt; ::= &lt;letter&gt; [ [ &lt;ldh-str&gt; ] &lt;let-dig&gt; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;ldh-str&gt; ::= &lt;let-dig-hyp&gt; | &lt;let-dig-hyp&gt; &lt;ldh-str&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;let-dig-hyp&gt; ::= &lt;let-dig&gt; | "-"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;let-dig&gt; ::= &lt;letter&gt; | &lt;digit&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;letter&gt; ::= any one of the 52 alphabetic characters A through Z in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upper case and a through z in lower case</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;digit&gt; ::= any one of the ten digits 0 through 9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>domain</code>由<code>subdomain</code>组成, <code>subdomain</code>的尾部由<code>label</code>组成, <code>label</code>的开头必须为<code>letter</code>(即字母)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/15/troubleshooting-and-fixing-null-pointer-exception-when-using-apache-httpclient5-for-dns-requests-for-services-with-non-compliant-fqdn#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3>
<p>在<code>kubernetes</code>中支持<code>&lt;service-name&gt;.&lt;tenant-id&gt;.svc.cluster.local</code>这种域名,
将客户端请求方式从<code>&lt;service-name&gt;.&lt;tenant-id&gt;</code>改为上述格式即可</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/15/troubleshooting-and-fixing-null-pointer-exception-when-using-apache-httpclient5-for-dns-requests-for-services-with-non-compliant-fqdn#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.1" target="_blank" rel="noopener noreferrer">RFC 1035</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener noreferrer">DNS for Services and Pods</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="java" term="java"/>
        <category label="kotlin" term="kotlin"/>
        <category label="FQDN" term="FQDN"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[kopia接入火山云TOS报错Access Denied问题的排查及修复]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2024/03/14/kopia-integration-with-volcano-cloud-tos-access-denied-issue-investigation-and-fix</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2024/03/14/kopia-integration-with-volcano-cloud-tos-access-denied-issue-investigation-and-fix"/>
        <updated>2024-03-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[kopia是一个备份工具, 支持多种存储后端, 包括对象存储, 文件系统等,]]></summary>
        <content type="html"><![CDATA[<p><code>kopia</code>是一个备份工具, 支持多种存储后端, 包括<code>对象存储</code>, <code>文件系统</code>等,
通过kopia可以将数据备份到不同的存储后端, 也可以从不同的存储后端恢复数据.
火山云<code>TOS</code>是火山云提供的对象存储服务, 支持通过<code>S3</code>协议访问.
最近在使用kopia接入火山云<code>TOS</code>时, 遇到了一个问题, 问题的现象是调用<code>kopia</code>提供的<code>s3_storage</code>接入火山云TOS时, 报错<code>Access Denied.</code></p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unable to determine if bucket "xxxxx" exists: Access Denied.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以下是该问题的原因及解决方案总结.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/14/kopia-integration-with-volcano-cloud-tos-access-denied-issue-investigation-and-fix#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h2>
<p>火山云对<code>S3</code>协议只有部分实现.
以请求方式为例, 只支持<code>Virtual Hosted-Style</code>的请求方式, 不支持<code>Path-Style</code>的请求方式.</p>
<blockquote>
<p>上述两种请求方式主要用于区分对不同的存储桶进行操作.
<code>Virtual Hosted-Style</code>:
这种请求方式是通过在域名中指定存储桶名称来进行操作, 如<code>https://{bucket-name}.s3.{region-code}.amazonaws.com</code>.
<code>Path-Style</code>:
这种请求方式是通过在域名后面指定存储桶名称来进行操作, 如`<a href="https://s3.{region-code}.amazonaws.com/%7Bbucket-name%7D" target="_blank" rel="noopener noreferrer">https://s3.{region-code}.amazonaws.com/{bucket-name}</a></p>
</blockquote>
<p><code>kopia</code>通过<code>minio</code>实现了对<code>S3</code>协议的支持, <code>minio</code>中默认情况下使用<code>Path-Style</code>的请求方式,
所以导致了<code>Access Denied</code>的问题.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/14/kopia-integration-with-volcano-cloud-tos-access-denied-issue-investigation-and-fix#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<p><code>minio</code>在创建<code>client</code>的时候提供了<code>BucketLookup</code>选项, 用于指定<code>client</code>使用的请求方式, 但是<code>kopia</code>没有暴露这个选项.<br>
目前已在<code>kopia</code>的<code>repo</code>中开了一个<a href="https://github.com/kopia/kopia/issues/3734" target="_blank" rel="noopener noreferrer">issue</a>, 需要等待后续的进展.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="https://www.geek66.cyou/zh-CN/blog/2024/03/14/kopia-integration-with-volcano-cloud-tos-access-denied-issue-investigation-and-fix#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li>
<p><a href="https://github.com/kopia/kopia" target="_blank" rel="noopener noreferrer">kopia</a></p>
</li>
<li>
<p><a href="https://www.volcengine.com/docs/6349" target="_blank" rel="noopener noreferrer">TOS</a></p>
</li>
<li>
<p><a href="https://www.volcengine.com/docs/6349/147050" target="_blank" rel="noopener noreferrer">AWS S3 协议兼容性说明</a></p>
</li>
</ul>
<blockquote>
<p>TOS 仅支持使用虚拟主机（即 VirtualHostStyle）的请求方式，不支持路径样式（即 PathStyle）的请求方式。因此使用各种支持 S3 协议的
SDK 和工具访问 TOS 时，请务必确保配置了 VirtualHostStyle 的请求方式。例如，使用 AWS S3 Java SDK 时，需要在客户端初始化时确保设置了禁用
PathStyle 的配置参数：AmazonS3Builder.withPathStyleAccessEnabled(false)。</p>
</blockquote>
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/VirtualHosting.html?spm=a2c4g.11186623.0.0.6b9d64012JMDoP" target="_blank" rel="noopener noreferrer">Virtual hosting of buckets</a></p>
</li>
<li>
<p><a href="https://github.com/kopia/kopia/issues/3734" target="_blank" rel="noopener noreferrer">Custmize minio creation options</a></p>
</li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="golang" term="golang"/>
        <category label="kopia" term="kopia"/>
        <category label="volcengine" term="volcengine"/>
        <category label="tos" term="tos"/>
        <category label="s3" term="s3"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[升级框架后发现Feign调用失败时间格式化问题的排查和解决]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/12/22/openfeign-zoned-datetime-formatting-problem</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/12/22/openfeign-zoned-datetime-formatting-problem"/>
        <updated>2023-12-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[问题现象]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题现象">问题现象<a href="https://www.geek66.cyou/zh-CN/blog/2023/12/22/openfeign-zoned-datetime-formatting-problem#%E9%97%AE%E9%A2%98%E7%8E%B0%E8%B1%A1" class="hash-link" aria-label="问题现象的直接链接" title="问题现象的直接链接">​</a></h2>
<p>升级内部框架版本后，发现Feign调用失败，报错如下：</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Failed to convert value of type 'java.lang.String' to required type 'java.time.ZonedDateTime'; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nested exception is org.springframework.core.convert.ConversionFailedException: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Failed to convert from type [java.lang.String] to type [@org.springframework.web.bind.annotation.RequestParam @org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime] for value '2023/12/18 02:57'; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	nested exception is java.lang.IllegalArgumentException: Parse attempt failed for value [2023/12/18 02:57]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>客户端伪代码如下:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">FeignClient</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token annotation punctuation" style="color:#393A34">@GetMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">PlatformStandardOrderDto</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token annotation punctuation" style="color:#393A34">@RequestParam</span><span class="token plain"> </span><span class="token class-name">ZonedDateTime</span><span class="token plain"> startTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token annotation punctuation" style="color:#393A34">@RequestParam</span><span class="token plain"> </span><span class="token class-name">ZonedDateTime</span><span class="token plain"> endTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个问题的现象是Feign调用时参数中的<code>ZonedDatetime</code>类型的时间格式化的结果服务端无法解析</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/12/22/openfeign-zoned-datetime-formatting-problem#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h2>
<blockquote>
<p>框架升级前后内部的时间格式化行为发生了变化导致这个问题的出现.<br>
在早期框架中我们自定义了一个<code>SpringMvcContract</code>.</p>
</blockquote>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation builtin">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation builtin">@Primary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">contract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapper</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ObjectMapper</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> discoverer</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DefaultParameterNameDiscoverer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Contract </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">SpringMvcContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">listOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">EntityFiltersMappingParameterProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapper</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> discoverer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">MatrixVariableParameterProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">RequestHeaderParameterProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">PathVariableParameterProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">RequestPartParameterProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">QueryMapParameterProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p><code>SpringMvcContract</code>够帮助我们实现Feign的注解参数的解析(例如<code>@RequestParam</code>, <code>@PathVariable</code>)</p>
</blockquote>
<blockquote>
<p>框架升级前的行为:<br>
由于框架升级前的代码没有为<code>SpringMvcContract</code>配置<code>ConversionService</code>, 所以<code>SpringMvcContract</code>无法处理<code>ZonedDateTime</code>
从而导致触发了Feign的默认行为也就是调用参数的<code>toString</code>方法来将参数转为String, 对于<code>ZonedDateTime</code>类型的参数,
调用<code>toString</code>方法, 生成的字符串格式为<code>iso-8601</code>格式, 例如<code>2023-12-18T02:57:00+08:00[Asia/Shanghai]</code>,
这种格式的字符串服务端是可以解析的</p>
<p>框架升级后的行为:<br>
由于框架内部配置了<code>ConversionService</code>, 所以会调用<code>ConversionService</code>的<code>convert</code>
方法来实现将参数的解析, <code>ConversionService</code>
最终会委托<code>FormattingConversionService</code>将<code>ZonedDateTime</code>类型的参数转为字符串, 这种情况下,
会将时间转为<code>yyyy/MM/dd HH:mm</code>格式的字符串, 所以导致了服务端无法解析.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/12/22/openfeign-zoned-datetime-formatting-problem#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<p>为参数增加<code>@DateTimeFormat</code>注解来指定时间格式化的格式, 例如:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">FeignClient</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token annotation punctuation" style="color:#393A34">@GetMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">PlatformStandardOrderDto</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token annotation punctuation" style="color:#393A34">@DateTimeFormat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iso </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DateTimeFormat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ISO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DATE_TIME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@RequestParam</span><span class="token plain"> </span><span class="token class-name">ZonedDateTime</span><span class="token plain"> startTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token annotation punctuation" style="color:#393A34">@DateTimeFormat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iso </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DateTimeFormat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ISO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DATE_TIME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@RequestParam</span><span class="token plain"> </span><span class="token class-name">ZonedDateTime</span><span class="token plain"> endTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题排查过程">问题排查过程<a href="https://www.geek66.cyou/zh-CN/blog/2023/12/22/openfeign-zoned-datetime-formatting-problem#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B" class="hash-link" aria-label="问题排查过程的直接链接" title="问题排查过程的直接链接">​</a></h2>
<ul>
<li>当FeignClient接口的方法被调用时, 会调用<code>ReflectiveFeign</code>来委托<code>MethodHandler</code>来处理方法调用</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"equals"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Object</span><span class="token plain"> otherHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInvocationHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">otherHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IllegalArgumentException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"hashCode"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"toString"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> dispatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中<code>dispatch</code>是用来保存方法名称和<code>MethodHandler</code>的映射关系的, <code>MethodHandler</code>是用来处理方法调用(
当前的实现中<code>MethodHandler</code>是<code>SynchronousMethodHandler</code>)</p>
<ul>
<li>MethodHandler内部的invoke执行流程如下:</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">RequestTemplate</span><span class="token plain"> template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> buildTemplateFromArgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">Options</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">Retryer</span><span class="token plain"> retryer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">retryer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">executeAndDecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">template</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RetryableException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				retryer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">continueOrPropagate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RetryableException</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token class-name">Throwable</span><span class="token plain"> cause </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCause</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagationPolicy </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UNWRAP</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> cause </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> cause</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logLevel </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token class-name">Logger</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Level</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NONE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">logRetry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">configKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logLevel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码中我们需要关心的是<code>buildTemplateFromArgs.create(argv);</code>这一行,
这一行代码会根据方法的参数来构建<code>RequestTemplate</code>,
<code>RequestTemplate</code>是用来保存请求的信息的, 例如请求的URL, 请求的方法,
请求的参数等等, 只要知道了<code>RequestTemplate</code>中对应参数的构造过程那么我们就可以知道Feign是如何将参数转为请求的参数的了</p>
<ul>
<li><code>buildTemplateFromArgs.create(argv);</code>的具体实现如下:</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RequestTemplate</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">RequestTemplate</span><span class="token plain"> mutable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">RequestTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">template</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mutable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">feignTarget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">urlIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> urlIndex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">urlIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">checkArgument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">urlIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"URI parameter %s was null"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> urlIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		mutable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">target</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">urlIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> varBuilder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LinkedHashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Entry</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Collection</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> entry </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">indexToName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">entrySet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Object</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Null values are skipped.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexToExpander</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">containsKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">expandElements</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexToExpander</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				varBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">RequestTemplate</span><span class="token plain"> template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> varBuilder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryMapIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// add query map parameters after initial resolve so that they take</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// precedence over any predefined values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Object</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryMapIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> queryMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">toQueryMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addQueryMapQueryParameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">headerMapIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token function" style="color:#d73a49">addHeaderMapHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">headerMapIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码中我们需要关注的是这个语句</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (value != null) { // Null values are skipped.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (indexToExpander.containsKey(i)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		value = expandElements(indexToExpander.get(i), value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	for (String name : entry.getValue()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		varBuilder.put(name, value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private Object expandElements(Expander expander, Object value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (value instanceof Iterable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return expandIterable(expander, (Iterable) value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return expander.expand(value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个语句会将参数转为<code>RequestTemplate</code>中的参数, <code>Expander</code>是<code>Feign</code>中的一个接口, 用来将参数转为字符串,
而<code>indexToExpander</code>表达的是参数的索引和<code>Expander</code>的映射关系,
在我们的<code>Case</code>中实际上是没有走到<code>indexToExpander</code>的, 所以最终会直接调用<code>varBuilder.put(name, value);</code>这一行,
这一行会将参数转为<code>RequestTemplate</code>中的参数,
后续需要将参数值转为字符串, 所以还需要了解<code>RequestTemplate</code>中的参数是如何转为字符串的,
所以需要查看<code>RequestTemplate template = resolve(argv, mutable, varBuilder);</code>
这一段调用的resolve方法, 具体实现如下:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected RequestTemplate resolve(Object[] argv,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">								  RequestTemplate mutable,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">								  Map&lt;String, Object&gt; variables) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return mutable.resolve(variables);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>接下来需要查看<code>RequestTemplate</code>中的<code>resolve</code>方法的实现, 具体实现如下:</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RequestTemplate</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> variables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">StringBuilder</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StringBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* create a new template form this one, but explicitly */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">RequestTemplate</span><span class="token plain"> resolved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">RequestTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uriTemplate </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* create a new uri template using the default root */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uriTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UriTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decodeSlash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">String</span><span class="token plain"> expanded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uriTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expanded </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expanded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">	 * for simplicity, combine the queries into the uri and use the resulting uri to seed the</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">	 * resolved template.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">	 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">queries</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 * since we only want to keep resolved query values, reset any queries on the resolved copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		resolved</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queries</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emptyMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">StringBuilder</span><span class="token plain"> query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StringBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Iterator</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">QueryTemplate</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> queryTemplates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">queries</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryTemplates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">QueryTemplate</span><span class="token plain"> queryTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> queryTemplates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">String</span><span class="token plain"> queryExpanded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> queryTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNotBlank</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryExpanded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryExpanded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryTemplates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"&amp;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">String</span><span class="token plain"> queryString </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">queryString</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Matcher</span><span class="token plain"> queryMatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">QUERY_STRING_PATTERN</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">matcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryMatcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">/* the uri already has a query, so any additional queries should be appended */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"&amp;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"?"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* add the uri to result */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	resolved</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* headers */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 * same as the query string, we only want to keep resolved values, so clear the header map on</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 * the resolved instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		resolved</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">headers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emptyMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HeaderTemplate</span><span class="token plain"> headerTemplate </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/* resolve the header */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">String</span><span class="token plain"> header </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> headerTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">/* split off the header values and add it to the resolved template */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token class-name">String</span><span class="token plain"> headerValues </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">substring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">indexOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">headerValues</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token comment" style="color:#999988;font-style:italic">/* append the header as a new literal as the value has already been expanded. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					resolved</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headerTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Literal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headerValues</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bodyTemplate </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		resolved</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bodyTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* mark the new template resolved */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	resolved</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resolved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resolved</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码比较长, 我们需要关注的是这一段:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	if (!this.queries.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       * since we only want to keep resolved query values, reset any queries on the resolved copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resolved.queries(Collections.emptyMap());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      StringBuilder query = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Iterator&lt;QueryTemplate&gt; queryTemplates = this.queries.values().iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      while (queryTemplates.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        QueryTemplate queryTemplate = queryTemplates.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String queryExpanded = queryTemplate.expand(variables);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Util.isNotBlank(queryExpanded)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          query.append(queryExpanded);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (queryTemplates.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            query.append("&amp;");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String queryString = query.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!queryString.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Matcher queryMatcher = QUERY_STRING_PATTERN.matcher(uri);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (queryMatcher.find()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          /* the uri already has a query, so any additional queries should be appended */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          uri.append("&amp;");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          uri.append("?");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uri.append(queryString);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终这个语句<code>String queryExpanded = queryTemplate.expand(variables);</code>会将参数转为字符串, 所以最终我们得到了参数的字符串形式,</p>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="spring-cloud" term="spring-cloud"/>
        <category label="spring-cloud-openfeign" term="spring-cloud-openfeign"/>
        <category label="openfeign" term="openfeign"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[升级到spring-boot-3.1.0后native-image启动报错以及问题解决]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions"/>
        <updated>2023-06-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[本文主要介绍升级到spring-boot-3.1.0后native-image启动报错以及对应问题的解决方案]]></summary>
        <content type="html"><![CDATA[<p>本文主要介绍升级到spring-boot-3.1.0后native-image启动报错以及对应问题的解决方案</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="orgspringframeworkbeansfactorybeancreationexception-error-creating-bean-with-name-entitymanagerfactory-no-classes-have-been-predefined-during-the-image-build-to-load-from-bytecodes-at-runtime">org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': No classes have been predefined during the image build to load from bytecodes at runtime.<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#orgspringframeworkbeansfactorybeancreationexception-error-creating-bean-with-name-entitymanagerfactory-no-classes-have-been-predefined-during-the-image-build-to-load-from-bytecodes-at-runtime" class="hash-link" aria-label="org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': No classes have been predefined during the image build to load from bytecodes at runtime.的�直接链接" title="org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': No classes have been predefined during the image build to load from bytecodes at runtime.的直接链接">​</a></h2>
<p>日志如下</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': No classes have been predefined during the image build to load from bytecodes at runtime.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1770) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:598) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:520) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:326) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:324) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1156) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:931) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:608) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:146) ~[fastone-auditing:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:733) ~[fastone-auditing:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:435) ~[fastone-auditing:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:311) ~[fastone-auditing:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1305) ~[fastone-auditing:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1294) ~[fastone-auditing:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at com.fastonetech.auditing.FastoneAuditingApplicationKt.main(FastoneAuditingApplication.kt:13) ~[fastone-auditing:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at com.fastonetech.auditing.FastoneAuditingApplicationKt.main(FastoneAuditingApplication.kt) ~[fastone-auditing:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: com.oracle.svm.core.jdk.UnsupportedFeatureError: No classes have been predefined during the image build to load from bytecodes at runtime.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.graalvm.nativeimage.builder/com.oracle.svm.core.util.VMError.unsupportedFeature(VMError.java:89) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.graalvm.nativeimage.builder/com.oracle.svm.core.hub.PredefinedClassesSupport.throwNoBytecodeClasses(PredefinedClassesSupport.java:76) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.graalvm.nativeimage.builder/com.oracle.svm.core.hub.PredefinedClassesSupport.loadClass(PredefinedClassesSupport.java:130) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.base@17.0.5/java.lang.ClassLoader.defineClass(ClassLoader.java:294) ~[fastone-auditing:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.utility.dispatcher.JavaDispatcher$DynamicClassLoader.invoker(JavaDispatcher.java:1383) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.utility.dispatcher.JavaDispatcher$InvokerCreationAction.run(JavaDispatcher.java:459) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.utility.dispatcher.JavaDispatcher$InvokerCreationAction.run(JavaDispatcher.java:452) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.base@17.0.5/java.security.AccessController.executePrivileged(AccessController.java:168) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.base@17.0.5/java.security.AccessController.doPrivileged(AccessController.java:318) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.utility.dispatcher.JavaDispatcher.doPrivileged(JavaDispatcher.java) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.utility.dispatcher.JavaDispatcher.&lt;clinit&gt;(JavaDispatcher.java:87) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.description.type.TypeDescription$ForLoadedType.&lt;clinit&gt;(TypeDescription.java:8659) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at net.bytebuddy.matcher.ElementMatchers.isFinalizer(ElementMatchers.java:1624) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.bytecode.internal.bytebuddy.ByteBuddyState$ProxyDefinitionHelpers.&lt;init&gt;(ByteBuddyState.java:296) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.bytecode.internal.bytebuddy.ByteBuddyState.&lt;clinit&gt;(ByteBuddyState.java:71) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.bytecode.internal.bytebuddy.BytecodeProviderImpl.&lt;init&gt;(BytecodeProviderImpl.java:123) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.bytecode.internal.bytebuddy.BytecodeProviderImpl.&lt;init&gt;(BytecodeProviderImpl.java:115) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.bytecode.internal.BytecodeProviderInitiator.buildBytecodeProvider(BytecodeProviderInitiator.java:59) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.bytecode.internal.BytecodeProviderInitiator.buildDefaultBytecodeProvider(BytecodeProviderInitiator.java:46) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.jpa.internal.enhance.EnhancingClassTransformerImpl.&lt;init&gt;(EnhancingClassTransformerImpl.java:34) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.jpa.boot.internal.PersistenceUnitInfoDescriptor.pushClassTransformer(PersistenceUnitInfoDescriptor.java:113) ~[fastone-auditing:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.&lt;init&gt;(EntityManagerFactoryBuilderImpl.java:340) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.&lt;init&gt;(EntityManagerFactoryBuilderImpl.java:190) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.vendor.SpringHibernateJpaPersistenceProvider.createContainerEntityManagerFactory(SpringHibernateJpaPersistenceProvider.java:60) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.createNativeEntityManagerFactory(LocalContainerEntityManagerFactoryBean.java:376) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.buildNativeEntityManagerFactory(AbstractEntityManagerFactoryBean.java:409) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.afterPropertiesSet(AbstractEntityManagerFactoryBean.java:396) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.afterPropertiesSet(LocalContainerEntityManagerFactoryBean.java:352) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1816) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1766) ~[fastone-auditing:6.0.9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... 17 common frames omitted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h3>
<p>这个问题是<code>springframework</code>和<code>hibernate</code>之间的集成问题, 需要将<code>springframework</code>升级到<code>6.0.10-SNAPSHOT</code>版本即可解决该问题
详细<code>issue</code>
见<a href="https://github.com/spring-projects/spring-framework/issues/30492" target="_blank" rel="noopener noreferrer">Skip class transformer in PersistenceUnitInfoDescriptor for native images #30492</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>现在在写解决方案的时候, <code>springframework</code>的最新版本是<code>6.0.9</code>, 如果后续<code>6.0.10</code>版本发布, 则可以直接使用<code>6.0.10</code>版本.</p></div></div>
<p>将<code>springframework</code>升级到<code>6.0.10-SNAPSHOT</code>版本, 该版本中修复了<code>hibernate</code>的集成问题.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">implementation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">platform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"org.springframework:spring-framework-bom:6.0.10-SNAPSHOT"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="orgspringframeworkbeansfactorybeancreationexception-error-creating-bean-with-name-entitymanagerfactory-null">org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': null<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#orgspringframeworkbeansfactorybeancreationexception-error-creating-bean-with-name-entitymanagerfactory-null" class="hash-link" aria-label="org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': null的直接链接" title="org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': null的直接链接">​</a></h2>
<p>日志如下</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory': null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1770) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:598) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:520) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:326) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:324) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1156) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:931) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:608) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:146) ~[springboot3-todo:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:733) ~[springboot3-todo:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:435) ~[springboot3-todo:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:311) ~[springboot3-todo:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1305) ~[springboot3-todo:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1294) ~[springboot3-todo:3.1.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at com.example.Application.main(Application.java:16) ~[springboot3-todo:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.lang.ExceptionInInitializerError: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.engine.jdbc.dialect.internal.DialectFactoryImpl.logSelectedDialect(DialectFactoryImpl.java:93) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.engine.jdbc.dialect.internal.DialectFactoryImpl.buildDialect(DialectFactoryImpl.java:88) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator.initiateService(JdbcEnvironmentInitiator.java:224) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator.initiateService(JdbcEnvironmentInitiator.java:34) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.boot.registry.internal.StandardServiceRegistryImpl.initiateService(StandardServiceRegistryImpl.java:119) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.service.internal.AbstractServiceRegistryImpl.createService(AbstractServiceRegistryImpl.java:264) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.service.internal.AbstractServiceRegistryImpl.initializeService(AbstractServiceRegistryImpl.java:239) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.service.internal.AbstractServiceRegistryImpl.getService(AbstractServiceRegistryImpl.java:216) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.boot.model.relational.Database.&lt;init&gt;(Database.java:45) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.boot.internal.InFlightMetadataCollectorImpl.getDatabase(InFlightMetadataCollectorImpl.java:229) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.boot.internal.InFlightMetadataCollectorImpl.&lt;init&gt;(InFlightMetadataCollectorImpl.java:197) ~[springboot3-todo:6.2.2.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.boot.model.process.spi.MetadataBuildingProcess.complete(MetadataBuildingProcess.java:166) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.metadata(EntityManagerFactoryBuilderImpl.java:1380) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.build(EntityManagerFactoryBuilderImpl.java:1451) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.vendor.SpringHibernateJpaPersistenceProvider.createContainerEntityManagerFactory(SpringHibernateJpaPersistenceProvider.java:74) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.createNativeEntityManagerFactory(LocalContainerEntityManagerFactoryBean.java:376) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.buildNativeEntityManagerFactory(AbstractEntityManagerFactoryBean.java:409) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.afterPropertiesSet(AbstractEntityManagerFactoryBean.java:396) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.afterPropertiesSet(LocalContainerEntityManagerFactoryBean.java:352) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1816) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1766) ~[springboot3-todo:6.0.10-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... 16 common frames omitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.lang.IllegalArgumentException: Invalid logger interface org.hibernate.dialect.DialectLogging (implementation not found in jdk.internal.loader.ClassLoaders$AppClassLoader@3ecf72fd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.jboss.logging.Logger.doGetMessageLogger(Logger.java:2564) ~[springboot3-todo:3.5.0.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.jboss.logging.Logger.getMessageLogger(Logger.java:2530) ~[springboot3-todo:3.5.0.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.jboss.logging.Logger.getMessageLogger(Logger.java:2516) ~[springboot3-todo:3.5.0.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.hibernate.dialect.DialectLogging.&lt;clinit&gt;(DialectLogging.java:31) ~[na:na]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... 37 common frames omitted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因-1">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0-1" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h3>
<p>这个问题是<code>hibernate</code>中涉及到反射调用的相关的类没有注册到<code>reflect-config.json</code>中导致的.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>现在在写这篇文章的时候,<code>org.graalvm.buildtools.native</code>的插件使用的<code>metadataRepository</code>的版本还是<code>0.3.0</code>.
这个版本中还没有为<code>hibernate</code>相关的类注册到<code>reflect-config.json</code>中, 如果后续<code>0.3.2</code>版本发布了, 那么可以直接使用<code>0.3.2</code>
版本的插件, 不需要再手动添加<code>reflect-config.json</code>文件了.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-1">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3>
<p>在<code>resources</code>下的<code>META-INF/native-image</code>下的名为<code>reflect-config.json</code>的文件中增加如下内容</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.dialect.DialectLogging_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.metamodel.mapping.MappingModelCreationLogging_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.engine.jdbc.env.internal.LobCreationLogging_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.boot.jaxb.JaxbLogger_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.cache.spi.SecondLevelCacheLogger_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.engine.jdbc.JdbcLogging_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.resource.beans.internal.BeansMessageLogger_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"name": "org.hibernate.sql.results.graph.embeddable.EmbeddableLoadingLogger_$logger",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"methods": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"name": "&lt;init&gt;",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"parameterTypes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					"org.jboss.logging.Logger"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h3>
<ul>
<li><a href="https://github.com/oracle/graalvm-reachability-metadata/pull/286" target="_blank" rel="noopener noreferrer">Fix compatibility with Hibernate 6.2.2</a></li>
<li><a href="https://github.com/oracle/graalvm-reachability-metadata/issues/297" target="_blank" rel="noopener noreferrer">Missing logger reflection entries for Hibernate 6.2</a></li>
<li><a href="https://github.com/oracle/graalvm-reachability-metadata/commit/afb9a1ee44e0a18b9cd31f04e038caea32d308a3" target="_blank" rel="noopener noreferrer">Add missing logger metadata for Hibernate 6.2</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>上面是我目前升级到<code>spring-boot-3.1.0</code>后遇到的问题, 总的来说这些问题都是因为框架内部的一些集成问题导致的.<br>
目前<code>graalvm</code>的<code>native-image</code>插件还不是很完善, 有些问题还需要我们自己去解决, 但是相信随着<code>graalvm</code>的发展, 这些问题都会逐渐解决的.
<code>oracle</code>维护了一个<code>graalvm</code>的<code>reachability-metadata</code>的项目, 用来解决一些框架集成的问题, 我们可以在这个项目中查看到一些框架的集成问题的解决方案.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料-1">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/06/01/upgrading-to-spring-boot-3.1.0-native-image-startup-errors-and-solutions#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-1" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://github.com/oracle/graalvm-reachability-metadata" target="_blank" rel="noopener noreferrer">graalvm-reachability-metadata</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="spring-boot" term="spring-boot"/>
        <category label="spring-framework" term="spring-framework"/>
        <category label="native-image" term="native-image"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[基于hibernate的spring-data-jpa的并发性能优化配置]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios"/>
        <updated>2023-05-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[摘要]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="摘要">摘要<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E6%91%98%E8%A6%81" class="hash-link" aria-label="摘要的直接链接" title="摘要的直接链接">​</a></h2>
<p>默认情况下，<code>spring-data-jpa</code>使用<code>hibernate</code>作为<code>jpa</code>的实现, 当并发量较大时, 由于框架的一些默认配置可能会引发性能瓶颈,
下面将介绍一些常见的配置项来改善并发量较大时的性能问题.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="禁用open-in-view">禁用<code>open-in-view</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E7%A6%81%E7%94%A8open-in-view" class="hash-link" aria-label="禁用open-in-view的直接链接" title="禁用open-in-view的直接链接">​</a></h2>
<p>在<code>spring-boot</code>中默认开启了<code>open-in-view</code>，这个配置项的作用是在整个请求上下文复用同一个<code>EntityManager</code>.<br>
该实现的好处是避免在同一个请求中多次创建一个<code>EntityManager</code>, 从而提高性能.<br>
当系统并发较大时且系统相应较慢, 由于<code>EntityManager</code>会持有数据库链接直到整个请求处理完成, 如果没有特别的需求, 例如:</p>
<ul>
<li>在<code>View</code>层使用Entity对象中<code>cascade</code>为<code>lazy</code>的关联对象</li>
</ul>
<p>可以考虑禁用<code>open-in-view</code>来提高性能</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3>
<p>在<code>application.yml</code>中添加如下配置:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">application.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jpa</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">open-in-view</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="覆盖hibernateconnectionhandling_mode配置项的默认配置">覆盖<code>hibernate.connection.handling_mode</code>配置项的默认配置<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E8%A6%86%E7%9B%96hibernateconnectionhandling_mode%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="覆盖hibernateconnectionhandling_mode配置项的默认配置的直接链接" title="覆盖hibernateconnectionhandling_mode配置项的默认配置的直接链接">​</a></h2>
<p><code>hibernate.connection.handling_mode</code>用于配置<code>EntityManager</code>中关联的数据库连接(创建及销毁时机)的控制.<br>
默认值创建时机为第一次与数据库交互, 关闭时机为<code>EntitiyManager</code>被关闭, 此举的目的是为了确保数据连接的最大化利用(
因为数据库连接的创建通常比较昂贵).<br>
但是对于带用<code>DataSource</code>的应用来说, 此配置并不会改善性能问题, 因为<code>DataSource</code>存在的意义就是复用数据库连接.<br>
并且由于<code>EntityManager</code>关联的数据库连接只有在关闭时才会被释放, 如果遇到<code>EntityManager</code>
长时间存活时并且此时系统并发较大会导致数据库没有空闲的连接导致后续请求被堵塞甚至获取数据库连接超时.<br></p>
<p>为了解决这个问题, 可以考虑配置<code>hibernate.connection.handling_mode</code>配置项对应的值,
该配置对应的枚举类为<code>PhysicalConnectionHandlingMode</code>, 枚举类中有如下几个值</p>
<p>对于没有使用<code>DataSource</code>的应用来说, 可以考虑以下几个值, 这几个值都是为了确保数据库连接的最大化利用, 因为创建数据库连接比较昂贵.</p>
<ul>
<li>IMMEDIATE_ACQUISITION_AND_HOLD
<br>表示连接会在<code>EntityManager</code>创建时获取, 关闭时释放.
<br>该配置的目的是为了能够在整个请求上下文中复用同一个数据库连接, 因为创建数据库连接比较昂贵.
但是对于带用<code>DataSource</code>的应用来说, 此配置并不会改善性能问题, 因为<code>DataSource</code>存在的意义就是复用数据库连接.</li>
<li>DELAYED_ACQUISITION_AND_HOLD<br>
<br>表示连接会<code>EntityManager</code>和数据库产生交互时获取, 关闭时释放. 这是默认的配置.
<br>此配置和上面的配置除了获取连接的时机不同外, 其他都相同.</li>
</ul>
<p>对于使用<code>DataSource</code>的应用来说, 可以积极地释放数据库链接来提高系统吞吐率, 因为<code>DataSource</code>已经帮我们做了数据库连接的复用,</p>
<ul>
<li>DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT
<br>如果需要执行多个独立的语句，那么可以选择此配置</li>
<li>DELAYED_ACQUISITION_AND_RELEASE_BEFORE_TRANSACTION_COMPLETION
<br>如果应用程序需要执行多个事务，并且不在乎事务的一致性，那么可以选择此配置.<br>
<br>这个配置一个潜在的问题是由于事务提交前会释放数据库连接, 如果后续事务提交时需要获取数据库连接时出现了问题会导致事务提交失败,
从而导致数据库中的事务一直处于开启状态</li>
<li>DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION
<br>如果需要处理事务, 并且为了保证事务的一致性, 那么可以选择此配置</li>
</ul>
<p>一般来说, 如果应用程序需要处理事务, 并且为了保证事务的一致性,
那么可以选择<code>DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION</code>配置.
如果应用不在乎事务的一致性, 那么可以选择<code>DELAYED_ACQUISITION_AND_RELEASE_BEFORE_TRANSACTION_COMPLETION</code>配置,
由于此配置会在事务提交前释放数据库连接,有可能会导致后续事务提交时获取数据库连接失败, 从而导致事务提交失败,
从而导致数据库中的事务一直处于开启状态, 所以此配置需要谨慎使用.
如果应用不需要处理事务, 那么可以选择<code>DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT</code>配置.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-1">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3>
<p>在<code>application.yml</code>中添加如下配置:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">application.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jpa</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hibernate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">connection</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">handling_mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> your_handling_mode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="open-in-view">Open In View<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#open-in-view" class="hash-link" aria-label="Open In View的直接链接" title="Open In View的直接链接">​</a></h3>
<ul>
<li><a href="https://www.baeldung.com/spring-open-session-in-view" target="_blank" rel="noopener noreferrer">A Guide to Spring’s Open Session in View</a></li>
<li><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/orm/jpa/support/OpenEntityManagerInViewInterceptor.html" target="_blank" rel="noopener noreferrer">OpenEntityManagerInViewInterceptor</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="connection-control">Connection Control<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#connection-control" class="hash-link" aria-label="Connection Control的直接链接" title="Connection Control的直接链接">​</a></h3>
<ul>
<li><a href="https://vladmihalcea.com/hibernate-aggressive-connection-release/" target="_blank" rel="noopener noreferrer">How does aggressive connection release work in Hibernate</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/6.2/userguide/html_single/Hibernate_User_Guide.html#database-connection-handling" target="_blank" rel="noopener noreferrer">Connection handling</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/6.2/javadocs/org/hibernate/resource/jdbc/spi/PhysicalConnectionHandlingMode.html" target="_blank" rel="noopener noreferrer">PhysicalConnectionHandlingMode</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/6.2/javadocs/org/hibernate/cfg/AvailableSettings.html" target="_blank" rel="noopener noreferrer">AvailableSettings</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="additional-high-performance-optimizations">Additional High-Performance Optimizations<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/26/performance-optimization-strategies-for-hibernate-in-concurrent-scenarios#additional-high-performance-optimizations" class="hash-link" aria-label="Additional High-Performance Optimizations的直接链接" title="Additional High-Performance Optimizations的直接链接">​</a></h3>
<ul>
<li><a href="https://vladmihalcea.com/tutorials/hibernate/" target="_blank" rel="noopener noreferrer">High-Performance Hibernate Tutorial</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/6.2/userguide/html_single/Hibernate_User_Guide.html#best-practices" target="_blank" rel="noopener noreferrer">Performance Tuning and Best Practices</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="spring-boot" term="spring-boot"/>
        <category label="spring-data-jpa" term="spring-data-jpa"/>
        <category label="hibernate" term="hibernate"/>
        <category label="performance" term="performance"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[解决无法输入中文字符到vscode]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/05/15/solve-unable-to-input-chinese-character-into-vscode</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/05/15/solve-unable-to-input-chinese-character-into-vscode"/>
        <updated>2023-05-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[当通过snap安装vscode后，无法输入中文字符，解决方案是在官网下载deb包安装，这样就可以输入中文字符了.]]></summary>
        <content type="html"><![CDATA[<p>当通过<code>snap</code>安装<code>vscode</code>后，无法输入中文字符，解决方案是在<a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">官网</a>下载<code>deb</code>包安装，这样就可以输入中文字符了.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/15/solve-unable-to-input-chinese-character-into-vscode#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://github.com/microsoft/vscode/issues/96041" target="_blank" rel="noopener noreferrer">unable to input chinese character</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="vscode" term="vscode"/>
        <category label="snap" term="snap"/>
        <category label="deb" term="deb"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[通过关闭OpenEntityManagerInViewInterceptor确保当下游服务响应缓慢时不会导致数据库连接被占用完]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/05/15/to-ensure-that-database-connections-are-not-exhausted-when-downstream-services-respond-slowly-by-closing-open-session-inview</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/05/15/to-ensure-that-database-connections-are-not-exhausted-when-downstream-services-respond-slowly-by-closing-open-session-inview"/>
        <updated>2023-05-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[OpenEntityManagerInViewInterceptor是spring中的一个拦截器，它的作用是在整个请求上下文复用同一个EntityManager]]></summary>
        <content type="html"><![CDATA[<p><code>OpenEntityManagerInViewInterceptor</code>是<code>spring</code>中的一个拦截器，它的作用是在整个请求上下文复用同一个<code>EntityManager</code>
，从而避免在一个请求中多次创建一个<code>EntityManager</code>, 从而提高性能.<br>
但是如果在一个请求的处理代码中请求了下游服务，而下游服务响应缓慢，那么在下游服务响应之前，<code>EntityManager</code>
会一直被占用，直到整个请求处理完成，这样会导致当服务并发请求量较大时，数据库连接被占用完.<br>
为了避免这种情况，可以通过关闭<code>OpenEntityManagerInViewInterceptor</code>来确保当下游服务响应缓慢时不会导致数据库连接被占用完.
下面将介绍如何关闭<code>OpenEntityManagerInViewInterceptor</code>.<br></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/15/to-ensure-that-database-connections-are-not-exhausted-when-downstream-services-respond-slowly-by-closing-open-session-inview#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<p>在<code>spring-boot</code>中，可以通过配置<code>spring.jpa.open-in-view</code>为<code>false</code>来关闭<code>OpenEntityManagerInViewInterceptor</code>，示例如下</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">application.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jpa</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">open-in-view</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="备注">备注<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/15/to-ensure-that-database-connections-are-not-exhausted-when-downstream-services-respond-slowly-by-closing-open-session-inview#%E5%A4%87%E6%B3%A8" class="hash-link" aria-label="备注的直接链接" title="备注的直接链接">​</a></h2>
<ul>
<li>
<p><code>org.springframework.orm.hibernate5.support.OpenSessionInViewInterceptor</code>在请求开始时会创建一个<code>EntityManager</code>
并调用<code>org.springframework.transaction.support.TransactionSynchronizationManager.bindResource</code>
方法来绑定<code>EntityManager</code>到当前线程</p>
</li>
<li>
<p>后续框架内部的调用例如<code>Repository.findAll()</code>的大致调用链路如下</p>
<ul>
<li>Repository.findAll()</li>
<li>org.springframework.orm.jpa.SharedEntityManagerCreator.SharedEntityManagerInvocationHandler.invoke</li>
<li>org.springframework.orm.jpa.EntityManagerFactoryUtils.doGetTransactionalEntityManager</li>
<li>org.springframework.transaction.support.TransactionSynchronizationManager.getResource
<br>因为在请求开始时已经将<code>EntityManager</code>绑定到当前线程，所以这里会获取到之前创建的<code>EntityManager</code></li>
</ul>
</li>
<li>
<p>后续执行<code>query</code>时会从<code>DataSource</code>中获取一个数据库连接，然后执行查询，查询完成后，数据库连接不会立即关闭，
而是在<code>EntityManager</code>被关闭时关闭，而<code>EntityManager</code>会在<code>OpenEntityManagerInViewInterceptor</code>被关闭时关闭.</p>
</li>
</ul>
<p>综上所述，当<code>OpenEntityManagerInViewInterceptor</code>被关闭时，<code>EntityManager</code>会被关闭，而<code>EntityManager</code>
被关闭时其对应的数据库连接也会被关闭.<br>
<code>EntityManager</code>被创建出来时不会立即创建数据库连接，而是在执行<code>sql</code>时才会创建数据库连接.<br>
如果整个请求链路非常耗时，那么在整个请求链路中，<code>EntityManager</code>对应的数据库连接都会被占用，直到整个请求链路执行完成.<br>
如果同时有多个请求正在执行, 那么会导致数据库连接被占用完. 从而导致后续请求无法获取数据库连接.<br>
为了避免这种情况，可以通过关闭<code>OpenEntityManagerInViewInterceptor</code>来确保当下游服务响应缓慢时不会导致数据库连接被占用完.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/15/to-ensure-that-database-connections-are-not-exhausted-when-downstream-services-respond-slowly-by-closing-open-session-inview#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://stackoverflow.com/questions/71140137/when-does-jpa-return-connection-to-db-pool" target="_blank" rel="noopener noreferrer">When does JPA return connection to db pool</a></li>
<li><a href="https://www.baeldung.com/spring-open-session-in-view" target="_blank" rel="noopener noreferrer">A Guide to Spring’s Open Session in View</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="spring-boot" term="spring-boot"/>
        <category label="spring-data-jpa" term="spring-data-jpa"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[通过创建rsa格式的私钥以及服务端启用rsa认证解决jsch连接ssh失败的问题]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/05/05/solve-jsch-ssh-connection-failure-by-creating-rsa-private-key-and-enabling-rsa-authentication-on-server</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/05/05/solve-jsch-ssh-connection-failure-by-creating-rsa-private-key-and-enabling-rsa-authentication-on-server"/>
        <updated>2023-05-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[服务建立ssh连接失败, 问题定位为jsch不支持openssh格式的私钥.]]></summary>
        <content type="html"><![CDATA[<p>服务建立<code>ssh</code>连接失败, 问题定位为<code>jsch</code>不支持<code>openssh</code>格式的私钥.<br>
在<code>OpenSSH 7.8</code>及之后的版本, <code>ssh-keygen</code>命令默认生成的私钥格式为<code>openssh</code>.<br>
该格式的头部为<code>-----BEGIN OPENSSH PRIVATE KEY-----</code>.<br></p>
<p>在将私钥转换为<code>rsa</code>格式后, 发现服务端还需要启用<code>rsa</code>认证, 在启用<code>rsa</code>认证后问题解决.<br></p>
<p>下面将详细介绍如何生成<code>rsa</code>格式的私钥以及服务端启用<code>rsa</code>认证.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="生成rsa格式的私钥">生成rsa格式的私钥<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/05/solve-jsch-ssh-connection-failure-by-creating-rsa-private-key-and-enabling-rsa-authentication-on-server#%E7%94%9F%E6%88%90rsa%E6%A0%BC%E5%BC%8F%E7%9A%84%E7%A7%81%E9%92%A5" class="hash-link" aria-label="生成rsa格式的私钥的直接链接" title="生成rsa格式的私钥的直接链接">​</a></h2>
<p>服务建立<code>ssh</code>链接失败, 日志如下</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: com.jcraft.jsch.JSchException: invalid privatekey: [B@e4487af</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.jcraft.jsch.KeyPair.load(KeyPair.java:664)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.jcraft.jsch.KeyPair.load(KeyPair.java:561)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.jcraft.jsch.IdentityFile.newInstance(IdentityFile.java:40)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.jcraft.jsch.JSch.addIdentity(JSch.java:407)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.jcraft.jsch.JSch.addIdentity(JSch.java:367)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在查阅了相关问题后, 发现<code>jsch</code>不支持<code>openssh</code>格式的私钥, 需要将私钥转换为<code>rsa</code>格式.<br></p>
<p>通过以下命令生成<code>rsa</code>格式的私钥</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen -t rsa -b 4096 -m PEM</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>后续会提示输入私钥的文件名, 以及私钥的密码, 一般直接回车即可.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="服务端启用rsa认证">服务端启用rsa认证<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/05/solve-jsch-ssh-connection-failure-by-creating-rsa-private-key-and-enabling-rsa-authentication-on-server#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E7%94%A8rsa%E8%AE%A4%E8%AF%81" class="hash-link" aria-label="服务端启用rsa认证的直接链接" title="服务端启用rsa认证的直接链接">​</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p><code>OpenSSH 8.8</code>及之后的版本默认禁用rsa认证, 需要手动启用, 可以通过<code>ssh -V</code>查看<code>sshd</code>版本</p></div></div>
<p>在生成了<code>rsa</code>格式的私钥后, 通过<code>ssh</code>连接服务端, 发现连接失败, 查看<code>sshd</code>日志发现如下错误</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">journalctl -t sshd -f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该命令输出如下内容</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">May 05 18:05:00 orange sshd[289365]: userauth_pubkey: signature algorithm ssh-rsa not in PubkeyAcceptedAlgorithms [preauth]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 05 18:05:00 orange sshd[289365]: error: Received disconnect from 127.0.0.1 port 55904:3: com.jcraft.jsch.JSchException: Auth fail [preauth]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 05 18:05:00 orange sshd[289365]: Disconnected from authenticating user fastone 127.0.0.1 port 55904 [preauth]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述日志中的<code>signature algorithm ssh-rsa not in PubkeyAcceptedAlgorithms [preauth]</code>说明<code>sshd</code>不支持<code>ssh-rsa</code>算法.<br></p>
<p>为了解决这个问题, 我们需要编辑<code>/etc/ssh/sshd_config</code>并增加以下内容</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/etc/ssh/sshd_config</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PubkeyAcceptedAlgorithms +ssh-rsa</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编辑完成后重启<code>sshd</code>服务</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart sshd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/05/05/solve-jsch-ssh-connection-failure-by-creating-rsa-private-key-and-enabling-rsa-authentication-on-server#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://stackoverflow.com/questions/53134212/invalid-privatekey-when-using-jsch" target="_blank" rel="noopener noreferrer">"Invalid privatekey" when using JSch</a></li>
<li><a href="https://www.matez.de/index.php/2020/10/16/support-for-openssh-default-key-format-in-jsch-fork/#:~:text=If%20you%20are%20a%20user,them%20to%20old%20pem%20format.&amp;text=Please%20upgrade%20to%20version%200.1,and%20give%20it%20a%20try." target="_blank" rel="noopener noreferrer">support for openssh default key format in jsch fork</a></li>
<li><a href="https://unix.stackexchange.com/questions/721606/ssh-server-gives-userauth-pubkey-key-type-ssh-rsa-not-in-pubkeyacceptedalgorit" target="_blank" rel="noopener noreferrer">SSH server gives "userauth_pubkey: key type ssh-rsa not in PubkeyAcceptedAlgorithms [preauth]" when connecting with Putty</a></li>
<li><a href="https://github.com/mwiede/jsch" target="_blank" rel="noopener noreferrer">第三方基于jsch fork出来的库</a></li>
<li><a href="https://stackoverflow.com/questions/54994641/openssh-private-key-to-rsa-private-key" target="_blank" rel="noopener noreferrer">Openssh Private Key to RSA Private Key</a></li>
<li><a href="https://wiki.archlinux.org/title/SSH_keys" target="_blank" rel="noopener noreferrer">SSH keys</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="jsch" term="jsch"/>
        <category label="openssh" term="openssh"/>
        <category label="sshd" term="sshd"/>
        <category label="ssh-keygen" term="ssh-keygen"/>
        <category label="rsa" term="rsa"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[使用kind创建一个k8s集群]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster"/>
        <updated>2023-04-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[kind是一个用于创建k8s集群的工具, 它使用docker容器作为节点, 可以快速创建一个k8s集群,]]></summary>
        <content type="html"><![CDATA[<p>kind是一个用于创建<code>k8s</code>集群的工具, 它使用<code>docker</code>容器作为节点, 可以快速创建一个<code>k8s</code>集群,
用于测试或者开发.<br>
官方提供了相应的文档<a href="https://kind.sigs.k8s.io/docs/user/ingress/" target="_blank" rel="noopener noreferrer">Ingress</a>, 在使用该文档的时候出现了一些问题.<br>
本文基于官方文档并作出了一定的修改介绍如何使用<code>kind</code>创建一个<code>k8s</code>集群, 并在集群中部署<code>kong-ingress</code>.最后部署一个测试应用并通过<code>kong-ingress</code>访问该应用.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装kind">安装kind<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E5%AE%89%E8%A3%85kind" class="hash-link" aria-label="安装kind的直接链接" title="安装kind的直接链接">​</a></h2>
<p>执行以下命令安装<code>kind</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go install sigs.k8s.io/kind@v0.18.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建一个k8s集群">创建一个k8s集群<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAk8s%E9%9B%86%E7%BE%A4" class="hash-link" aria-label="创建一个k8s集群的直接链接" title="创建一个k8s集群的直接链接">​</a></h2>
<p>执行以下命令创建一个<code>k8s</code>集群, 集群中包含一个<code>master</code>节和一个<code>worker</code>节点.<br>
同时将<code>master</code>节点的<code>80&amp;443</code>端口映射到宿主机的<code>80&amp;443</code>端口, 用于后续将<code>ingress</code>映射到宿主机的<code>80&amp;443</code>端口.<br></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF | kind create cluster --config=-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kind.x-k8s.io/v1alpha4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - role: control-plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubeadmConfigPatches:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kind: InitConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nodeRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          kubeletExtraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            node-labels: "ingress-ready=true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    extraPortMappings:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hostPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - containerPort: 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hostPort: 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - role: worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行<code>docker ps</code>命令查看<code>kind</code>创建的<code>docker</code>容器</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER ID   IMAGE                               COMMAND                  CREATED       STATUS       PORTS                                                                 NAMES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b4368e7fbfb1   kindest/node:v1.26.3                "/usr/local/bin/entr…"   2 hours ago   Up 2 hours   0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 127.0.0.1:45145-&gt;6443/tcp   kind-control-plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c0638805438a   kindest/node:v1.26.3                "/usr/local/bin/entr…"   2 hours ago   Up 2 hours                                                                         kind-worker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复�制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装kong">安装<code>kong</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E5%AE%89%E8%A3%85kong" class="hash-link" aria-label="安装kong的直接链接" title="安装kong的直接链接">​</a></h2>
<p>执行以下命令安装<code>kong-ingress</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Kong/kubernetes-ingress-controller/main/deploy/single/all-in-one-dbless.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置kong">配置<code>kong</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E9%85%8D%E7%BD%AEkong" class="hash-link" aria-label="�配置kong的直接链接" title="配置kong的直接链接">​</a></h2>
<p>执行以下命令配置<code>kong</code>.<br>
第一个命令用于将<code>deployment</code>为<code>proxy-kong</code>下面的<code>pod</code>的<code>replicas</code>设置为<code>1</code>同时将端口映射到<code>host</code>上(
这里的host就是<code>docker</code>容器的<code>host</code>, 同时docker容器对应的<code>port</code>又映射到了本地的端口).<br></p>
<p>第二个命令用于将<code>kong-proxy</code>的<code>service</code>的类型设置为<code>NodePort</code>, 这样就可以通过<code>host</code>的<code>port</code>访问<code>kong</code>了.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch deployment -n kong proxy-kong -p '{"spec":{"replicas":1, "template":{"spec":{"containers":[{"name":"proxy", "ports":[{"containerPort":8000,"hostPort":80,"name":"proxy","protocol":"TCP"},{"containerPort":8443,"hostPort":443,"name":"proxy-ssl","protocol":"TCP"}]}],"nodeSelector":{"ingress-ready":"true"},"tolerations":[{"key":"node-role.kubernetes.io/control-plane","operator":"Equal","effect":"NoSchedule"},{"key":"node-role.kubernetes.io/master","operator":"Equal","effect":"NoSchedule"}]}}}}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch service -n kong kong-proxy -p '{"spec":{"type":"NodePort"}}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动测试应用">启动测试应用<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95%E5%BA%94%E7%94%A8" class="hash-link" aria-label="启动测试应用的直接链接" title="启动测试应用的直接链接">​</a></h2>
<p>创建如下文件用于后续执行<code>kubectl apply</code>命令</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">usage.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /agnhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> netexec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"8080"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opsdockerimage/e2e</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">images</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agnhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2.26</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Default port used by the image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /agnhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> netexec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"8080"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opsdockerimage/e2e</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">images</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agnhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2.26</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Default port used by the image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /foo(/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">$)(.</span><span class="token important">*)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /bar(/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">$)(.</span><span class="token important">*)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker puull kind load docker-image opsdockerimage/e2e-test-images-agnhost:2.26s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind load docker-image opsdockerimage/e2e-test-images-agnhost:2.26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f usage.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E6%B5%8B%E8%AF%95" class="hash-link" aria-label="测试的直接链接" title="测试的直接链接">​</a></h2>
<p>执行以下命令测试</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl localhost/foo/hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl localhost/bar/hostname</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="遇到的问题">遇到的问题<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98" class="hash-link" aria-label="遇到的问题的直接链接" title="遇到的问题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx和contour等ingress安装失败"><code>nginx</code>和<code>contour</code>等<code>ingress</code>安装失败<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#nginx%E5%92%8Ccontour%E7%AD%89ingress%E5%AE%89%E8%A3%85%E5%A4%B1%E8%B4%A5" class="hash-link" aria-label="nginx和contour等ingress安装失败的直接链接" title="nginx和contour等ingress安装失败的直接链接">​</a></h3>
<p>这个问题的原因是因为国内无法下载对应的镜像导致无法安装成功.<br>
解决方案是采用<code>kong</code>作为<code>ingress</code>.<br></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官方文档中的关于kong的ingress的配置无法生效">官方文档中的关于<code>kong</code>的<code>ingress</code>的配置无法生效<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E7%9A%84%E5%85%B3%E4%BA%8Ekong%E7%9A%84ingress%E7%9A%84%E9%85%8D%E7%BD%AE%E6%97%A0%E6%B3%95%E7%94%9F%E6%95%88" class="hash-link" aria-label="官方文档中的关于kong的ingress的配置无法生效的直接链接" title="官方文档中的关于kong的ingress的配置无法生效的直接链接">​</a></h3>
<p>执行官方文档中的如下命令失败</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch deployment -n kong ingress-kong -p '{"spec":{"template":{"spec":{"containers":[{"name":"proxy","ports":[{"containerPort":8000,"hostPort":80,"name":"proxy","protocol":"TCP"},{"containerPort":8443,"hostPort":443,"name":"proxy-ssl","protocol":"TCP"}]}],"nodeSelector":{"ingress-ready":"true"},"tolerations":[{"key":"node-role.kubernetes.io/control-plane","operator":"Equal","effect":"NoSchedule"},{"key":"node-role.kubernetes.io/master","operator":"Equal","effect":"NoSchedule"}]}}}}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>报错如下</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">The Deployment "ingress-kong" is invalid: spec.template.spec.containers[0].image: Required value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个问题的原因是因为<code>deployment</code>给错了, 正确的<code>deployment</code>应该是<code>proxy-kong</code>.<br></p>
<p>将命令中的<code>ingress-kong</code>替换为<code>proxy-kong</code>后, 执行成功.<br></p>
<p>对于这个问题, 我已经提交了pr, 但是还没有被合并, 可以参考<br>
<a href="https://github.com/kubernetes-sigs/kind/pull/3183" target="_blank" rel="noopener noreferrer">doc: fix wrong implementation of creation of kong-ingress #3183</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/23/use-kind-create-a-k8s-cluster#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://kind.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">kind</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="kind" term="kind"/>
        <category label="k8s" term="k8s"/>
        <category label="docker" term="docker"/>
        <category label="github-pr" term="github-pr"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[使用S3托管静态网站]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3"/>
        <updated>2023-04-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[静态网站是指不需要后端服务的网站, 比如个人博客, 个人简历, 个人作品集等.]]></summary>
        <content type="html"><![CDATA[<p>静态网站是指不需要后端服务的网站, 比如个人博客, 个人简历, 个人作品集等. <br>
这些网站的内容都是静态的, 不需要后端服务, 只需要将静态文件托管到一个服务器上即可.<br>
本文将介绍如何使用AWS S3托管静态网站.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建s3桶">创建s3桶<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3#%E5%88%9B%E5%BB%BAs3%E6%A1%B6" class="hash-link" aria-label="创建s3桶的直接链接" title="创建s3桶的直接链接">​</a></h2>
<p>首先, 我们需要创建一个s3桶, 用于存放静态文件.</p>
<p>打开AWS控制台, 选择S3服务, 点击创建桶.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启用s3静态网站托管">启用s3静态网站托管<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3#%E5%90%AF%E7%94%A8s3%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E6%89%98%E7%AE%A1" class="hash-link" aria-label="启用s3静态网站托管的直接链接" title="启用s3静态网站托管的直接链接">​</a></h2>
<p>进入s3桶, 点击<code>Properties</code>这个<code>Tab</code>, 在<code>Static website hosting</code>这个<code>Section</code>中点击<code>Edit</code>按钮.
界面如下:
<img decoding="async" loading="lazy" alt="2023-04-20 14-43-25.png" src="https://www.geek66.cyou/zh-CN/assets/images/2023-04-20-14-43-25-b19076b9cc6fb8b10abf06c9a2882029.png" width="800" height="923" class="img_ev3q">
填写必要的信息, 点击保存.</p>
<p>保存完成之后再次进入<code>Properties</code>这个<code>Tab</code>中, 在<code>Static website hosting</code>这个<code>Section</code>中可以看到<code>Bucket website endpoint</code>
已经显示出来了, 这个就是我们的静态网站地址.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="公开桶">公开桶<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3#%E5%85%AC%E5%BC%80%E6%A1%B6" class="hash-link" aria-label="公开桶的直接链接" title="公开桶的直接链接">​</a></h2>
<p>默认情况下, s3是私有的, 无法通过公网访问. 我们需要将桶设置为公开, 以便通过公网访问.</p>
<p>进入s3桶, 点击<code>Permissions</code>这个<code>Tab</code>, 在<code>Block public access (bucket settings)</code>这个<code>Section</code>中点击<code>Edit</code>按钮, 界面如下:
<img decoding="async" loading="lazy" alt="2023-04-20 14-49-00.png" src="https://www.geek66.cyou/zh-CN/assets/images/2023-04-20-14-50-45-f7c7722e8a05006617f0f75d3272effe.png" width="972" height="871" class="img_ev3q">
取消<code>Block all public access</code>的勾选, 点击保存.</p>
<p>另外还需要设置<code>Bucket policy</code>, 在<code>Bucket policy</code>这个<code>Section</code>中点击<code>Edit</code>按钮, 输入如下配置后保存.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>将<code>Bucket-Name</code>替换为自己的桶名称</p></div></div>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"Version": "2012-10-17",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"Statement": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"Sid": "PublicReadGetObject",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"Effect": "Allow",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"Principal": "*",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"Action": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"s3:GetObject"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"Resource": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				"arn:aws:s3:::Bucket-Name/*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="上传静态文件">上传静态文件<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3#%E4%B8%8A%E4%BC%A0%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6" class="hash-link" aria-label="上传静态文件的直接链接" title="上传静态文件的直接链接">​</a></h2>
<p>通过<code>aws-cli</code>或者<code>web-console</code>上传静态文件到s3桶中.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/16/hosting-a-static-website-using-s3#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://docs.amazonaws.cn/en_us/AmazonS3/latest/userguide/WebsiteHosting.html" target="_blank" rel="noopener noreferrer">Hosting a static website using Amazon S3</a></li>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteAccessPermissionsReqd.html" target="_blank" rel="noopener noreferrer">Setting permissions for website access</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="aws" term="aws"/>
        <category label="s3" term="s3"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[使用Gradle的JavaPackager插件将Java应用打包成二进制文件]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app"/>
        <updated>2023-04-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[在之前的文章中, 我介绍过如何通过graalvm将java应用打包成二进制文件, 但是这种方式需要在graalvm中安装native-image]]></summary>
        <content type="html"><![CDATA[<p>在之前的文章中, 我介绍过如何通过<code>graalvm</code>将<code>java</code>应用打包成二进制文件, 但是这种方式需要在<code>graalvm</code>中安装<code>native-image</code>
工具, 并且需要在<code>graalvm</code>中编译<code>java</code>应用, 这样的方式对于<code>java</code>应用的开发者来说, 有一定的门槛, 而且也不够灵活.
并且构建过程中由于代码没有满足<code>graalvm</code>的要求, 例如使用了<code>java</code>的反射机制, 会导致构建失败(
graalvm需要在编译时就知道这些信息来生成)
下面将介绍另一种方式, 通过<code>gradle</code>的<code>JavaPackager</code>插件来构建二进制文件.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="添加插件">添加插件<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6" class="hash-link" aria-label="添加插件的直接链接" title="添加插件的直接链接">​</a></h2>
<p>要启用此插件, 需要在<code>build.gradle.kts</code>中添加如下配置:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>由于该插件没有发布到<code>gradle</code>的插件仓库中, 所以需要在<code>buildscript</code>中添加对应的依赖并通过<code>apply</code>来启用该插件</p></div></div>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">build.gradle.kts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">buildscript </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	repositories </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		maven </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"https://mirrors.huaweicloud.com/repository/maven/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		maven </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"https://mirrors.tencent.com/nexus/repository/maven-public/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		maven </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"https://maven.aliyun.com/nexus/content/groups/public/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		maven </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"https://oss.sonatype.org/content/repositories/snapshots"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dependencies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">classpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"io.github.fvarrui:javapackager:1.7.0"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal singleline string" style="color:#e3116c">"io.github.fvarrui.javapackager.plugin"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="插件配置">插件配置<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="插件配置的直接链接" title="插件配置的直接链接">​</a></h2>
<p>以<code>linux</code>为例, 介绍如何配置<code>JavaPackager</code>插:</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">build.gradle.kts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">configure</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">PackagePluginExtension</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">mainClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"&lt;MAIN-CLASS&gt;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">platform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Platform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linux</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">packagingJdk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"java.home"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// arch(Arch.x64) not work</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// arch is not configured in DefaultPackageTask(导致自定义arch失效)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// packagingJdk没有设置默认值(导致jink定位到了/bin目录下而不是用户的jdk的home目录下的bin目录)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将上面的的模板替换为自己的<code>mainClass</code>即可, 其他的配置可以根据需要进行修改.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="构建">构建<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E6%9E%84%E5%BB%BA" class="hash-link" aria-label="构建的直接链接" title="构建的直接链接">​</a></h2>
<p>执行如下命令即可构建:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./gradlew package -x test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="已知问题">已知问题<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98" class="hash-link" aria-label="已知问题的直接链接" title="已知问题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="packagingjdk不会自动推断导致打包失败"><code>packagingJdk</code>不会自动推断导致打包失败<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#packagingjdk%E4%B8%8D%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%8E%A8%E6%96%AD%E5%AF%BC%E8%87%B4%E6%89%93%E5%8C%85%E5%A4%B1%E8%B4%A5" class="hash-link" aria-label="packagingjdk不会自动推断导致打包失败的直接链接" title="packagingjdk不会自动推断导致打包失败的直接链接">​</a></h3>
<p>执行过程中出现如下错误</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> /bin/sh: 1: /bin/jdeps: not found</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h4>
<p>该问题的原因是<code>JavaPackager</code>插件在执行<code>jdeps</code>命令时会根据<code>packagingJdk</code>配置的值拼接<code>/bin/jdeps</code>来执行,
但是由于没有配置<code>packagingJdk</code>的值, 所以默认使用了<code>/bin/jdeps</code>来执行, 但是<code>/bin/jdeps</code>并不存在, 所以导致了上面的错误.</p>
<p>相关代码在<code>io.github.fvarrui.javapackager.packagers.BundleJre</code>类的<code>doApply</code>方法中, 这个方法中会调用<code>jdeps</code>命令来获取依赖信息.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h4>
<p>解决方案就是在上面的配置中添加<code>packagingJdk</code>的配置<code>packagingJdk(file(System.getProperty("java.home")))</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>2023-05-23<br>
相关pr已提交, 链接如下<br>
<a href="https://github.com/fvarrui/JavaPackager/pull/332" target="_blank" rel="noopener noreferrer">fix(gradle-default-package-task): Set default packagingJdk for bundle-jre #332</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jdeps命令执行失败报错module-xxx-not-found-required-by-xxx"><code>jdeps</code>命令执行失败报错<code>Module xxx not found, required by xxx</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#jdeps%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5%E6%8A%A5%E9%94%99module-xxx-not-found-required-by-xxx" class="hash-link" aria-label="jdeps命令执行失败报错module-xxx-not-found-required-by-xxx的直接链接" title="jdeps命令执行失败报错module-xxx-not-found-required-by-xxx的直接链接">​</a></h3>
<p>在我的<code>case</code>中报错为:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Module org.yaml.snakeyaml not found, required by com.fasterxml.jackson.dataformat.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因-1">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0-1" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h4>
<p>这个问题的原因通常是因为被依赖的模块版本需要升级到支持<code>java9</code>模块化之后的版本</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-1">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h4>
<p>在我的<code>case</code>中是<code>org.yaml.snakeyaml</code>需要升级, 在<code>build.gradle.kts</code>中添加如下配置后问题解决:</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">build.gradle.kts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">implementation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"org.yaml:snakeyaml:2.0"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jdeps命令执行失败报错javautilconcurrentexecutionexception-comsuntoolsjdepsmultireleaseexception"><code>jdeps</code>命令执行失败报错<code>java.util.concurrent.ExecutionException: com.sun.tools.jdeps.MultiReleaseException</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#jdeps%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5%E6%8A%A5%E9%94%99javautilconcurrentexecutionexception-comsuntoolsjdepsmultireleaseexception" class="hash-link" aria-label="jdeps命令执行失败报错javautilconcurrentexecutionexception-comsuntoolsjdepsmultireleaseexception的直接链接" title="jdeps命令执行失败报错javautilconcurrentexecutionexception-comsuntoolsjdepsmultireleaseexception的直接链接">​</a></h3>
<p>这个问题的原因是因为jdk17中的<code>jdeps</code>命令存在<code>bug</code>(无法处理不同jar中具有相同名称的类)导致的, 在jdk18中已经修复了这个问题.</p>
<p>关于这个问题的更多信息可以参考</p>
<ul>
<li><a href="https://stackoverflow.com/questions/69943899/jdeps-cant-print-module-deps-due-to-a-multireleaseexception" target="_blank" rel="noopener noreferrer">jdeps can't print-module-deps due to a MultiReleaseException</a></li>
<li><a href="https://bugs.openjdk.org/browse/JDK-8277165" target="_blank" rel="noopener noreferrer">JDK-8277165</a></li>
<li><a href="https://bugs.openjdk.org/browse/JDK-8277166" target="_blank" rel="noopener noreferrer">JDK-8277166</a></li>
<li><a href="https://bugs.openjdk.org/browse/JDK-8277123" target="_blank" rel="noopener noreferrer">JDK-8277123</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="构建过程中出现javalangexception-httpsgithubcomappimageappimagekitreleasesdownload13appimagetool-x86_64appimagenot-found--unsupported-os-architecture-x86_64">构建过程中出现<code>java.lang.Exception: https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImagenot found! ... Unsupported OS architecture x86_64?</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%87%BA%E7%8E%B0javalangexception-httpsgithubcomappimageappimagekitreleasesdownload13appimagetool-x86_64appimagenot-found--unsupported-os-architecture-x86_64" class="hash-link" aria-label="构建过程中出现javalangexception-httpsgithubcomappimageappimagekitreleasesdownload13appimagetool-x86_64appimagenot-found--unsupported-os-architecture-x86_64的直接链接" title="构建过程中出现javalangexception-httpsgithubcomappimageappimagekitreleasesdownload13appimagetool-x86_64appimagenot-found--unsupported-os-architecture-x86_64的直接链接">​</a></h3>
<p>这个问题的原因是在打包<code>linux</code>的<code>AppImage</code>时, 会去下载<code>appimagetool</code>来进行打包, 下载过程中可能会出现网络问题导致下载失败,
从而导致打包失败.
但是作者捕获相关异常后没有将原始信息打印出来, 导致我们无法知道具体的错误信息, 从而导致了上面的错误.
(这个异常信息是伪信息)</p>
<p>相关代码在<code>io.github.fvarrui.javapackager.packagers.GenerateAppImage</code>中的<code>getAppImageTool</code>方法中.<br></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-2">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h4>
<p>重试后问题解决.对于这个问题后续计划提PR给作者.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>2023-06-10<br>
相关pr已提交, 链接如下<br>
<a href="https://github.com/fvarrui/JavaPackager/pull/337" target="_blank" rel="noopener noreferrer">improvement: Improve the error message when downloading the AppImageTool fails #337</a></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arch配置不生效导致生成出的deb文件无法安装"><code>arch</code>配置不生效导致生成出的deb文件无法安装<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#arch%E9%85%8D%E7%BD%AE%E4%B8%8D%E7%94%9F%E6%95%88%E5%AF%BC%E8%87%B4%E7%94%9F%E6%88%90%E5%87%BA%E7%9A%84deb%E6%96%87%E4%BB%B6%E6%97%A0%E6%B3%95%E5%AE%89%E8%A3%85" class="hash-link" aria-label="arch配置不生效导致生成出的deb文件无法安装的直接链接" title="arch配置不生效导致生成出的deb文件无法安装的直接链接">​</a></h3>
<p>执行完<code>package</code>任务后, 会在<code>build</code>目录下生成相应的<code>deb</code>文件名称为<code>xxx.deb</code>.
对此文件执行<code>sudo dpkg -i xxx.deb</code>命令会出现如下错误:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dpkg: warning: parsing file '/var/lib/dpkg/tmp.ci/control' near line 5 package 'upshift:${info.arch.deb}':</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> '${info.arch.deb}' is not a valid architecture name in 'Architecture' field: must start with an alphanumeric</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg: error processing archive upshift_1.0-SNAPSHOT.deb (--install):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> package architecture (${info.arch.deb}) does not match system (amd64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Errors were encountered while processing:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> upshift_1.0-SNAPSHOT.deb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>后续在<code>gradle</code>中的task配置<code>arch(Arch.x64)</code>依然不生效.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因-2">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0-2" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h4>
<p>这个问题的原因是<code>JavaPackager</code>插件对应的gradle中的实现类是<code>io.github.fvarrui.javapackager.gradle.DefaultPackageTask</code>,
此插件并没有获取我们配置的<code>PackagePluginExtension</code>中的值.
后续<code>io.github.fvarrui.javapackager.packagers.GenerateDeb</code>会调用<code>velocity</code>来渲染<code>control.vtl</code>.
由于<code>arch</code>为空, 所以导致<code>${info.arch.deb}</code>没有被渲染, 模板内容如下</p>
<div class="language-title=&quot;control.vtl&quot; codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-title=&quot;control.vtl&quot; codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Package: ${info.name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Version: ${info.version}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Section: misc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Priority: optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Architecture: ${info.arch.deb}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Maintainer: ${info.organizationName} &lt;$!{info.organizationEmail}&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description: ${info.description}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Distribution: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if(${info.url})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Homepage: ${info.url}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-3">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h4>
<p>目前没有一个好的办法解决此问题, 后续准备在<code>JavaPackager</code>插件中提一个<code>PR</code>来解决此问题.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>2023-05-22<br>
相关pr已提交, 链接如下<br>
<a href="https://github.com/fvarrui/JavaPackager/pull/331" target="_blank" rel="noopener noreferrer">fix(gradle-default-package-task): Set arch field for deb control file rendering #331</a></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="备注">备注<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E5%A4%87%E6%B3%A8" class="hash-link" aria-label="备注的直接链接" title="备注的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解压appimage">解压AppImage<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E8%A7%A3%E5%8E%8Bappimage" class="hash-link" aria-label="解压AppImage的直接链接" title="解压AppImage的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./xxx.AppImage --appimage-extract</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/15/use-gradle-plugin-java-packager-to-build-binary-java-app#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://github.com/fvarrui/JavaPackager/blob/master/src/main/java/io/github/fvarrui/javapackager/packagers/BundleJre.java" target="_blank" rel="noopener noreferrer">BundleJre.java</a></li>
<li><a href="https://github.com/fvarrui/JavaPackager/blob/master/src/main/java/io/github/fvarrui/javapackager/gradle/DefaultPackageTask.java" target="_blank" rel="noopener noreferrer">DefaultPackageTask.java</a></li>
<li><a href="https://github.com/fvarrui/JavaPackager/blob/master/src/main/java/io/github/fvarrui/javapackager/packagers/LinuxPackager.java" target="_blank" rel="noopener noreferrer">LinuxPackager.java</a></li>
<li><a href="https://github.com/fvarrui/JavaPackager/blob/master/src/main/java/io/github/fvarrui/javapackager/packagers/GenerateDeb.java" target="_blank" rel="noopener noreferrer">GenerateDeb.java</a></li>
<li><a href="https://github.com/fvarrui/JavaPackager/blob/master/src/main/resources/linux/control.vtl" target="_blank" rel="noopener noreferrer">control.vtl</a></li>
<li><a href="https://github.com/fvarrui/JavaPackager/blob/master/src/main/java/io/github/fvarrui/javapackager/packagers/GenerateAppImage.java" target="_blank" rel="noopener noreferrer">GenerateAppImage.java</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="native-image" term="native-image"/>
        <category label="java-packager" term="java-packager"/>
        <category label="gradle-plugin" term="gradle-plugin"/>
        <category label="github-pr" term="github-pr"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[解决在Kotlin Coroutines中的命令行调用中出现Stream Closed异常]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine"/>
        <updated>2023-04-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[之前有一个服务内部需要调用外部程序(rclone), 于是我写了一个类来封装命令行调用, 该类主要是基于kotlinx.coroutines]]></summary>
        <content type="html"><![CDATA[<p>之前有一个服务内部需要调用外部程序(<code>rclone</code>), 于是我写了一个类来封装命令行调用, 该类主要是基于<code>kotlinx.coroutines</code>
来实现的.<br>
代码如下:</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">CommandExecutorImpl.kt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> java</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IOException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> java</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InputStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> CommandExecutorImpl </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandExecutor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LogCapability </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">suspend</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandExecutionOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		coroutineScope </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> String </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">joinToString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">separator </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal singleline string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"$ {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> process</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Process </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> asyncReadStdOut </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asyncRead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consume </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onNewStdoutRead</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> asyncReadStderr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asyncRead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">errorStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consume </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onNewStderrRead</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAlive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token function" style="color:#d73a49">delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">exitValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">IllegalStateException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"Process exited with non-zero exit code"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">// https://kotlinlang.org/docs/cancellation-and-timeouts.html#run-non-cancellable-block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token function" style="color:#d73a49">withContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NonCancellable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">destroy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					asyncReadStdOut</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cancelAndJoin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					asyncReadStderr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cancelAndJoin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">suspend</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandExecutionOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Process </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">withContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Dispatchers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRuntime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">exec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toTypedArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> CoroutineScope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">asyncRead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> InputStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consume</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">suspend</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Job </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		launch </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bufferedReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lineSequence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">asFlow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">						</span><span class="token function" style="color:#d73a49">consume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> IOException</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"Error while reading from process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> ex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">companion</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">object</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LogCapability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最近我发现在使用该类时, 有时会抛出<code>java.io.IOException: Stream closed</code>异常<br>
异常栈如下:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">14:10:38.016 [DefaultDispatcher-worker-117] WARN com.fastonetech.billing.sync.infra.command.CommandExecutorImpl - Error while reading from process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.io.IOException: Stream closed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/java.io.BufferedInputStream.getBufIfOpen(BufferedInputStream.java:168)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/java.io.BufferedInputStream.read(BufferedInputStream.java:334)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:270)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:313)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/sun.nio.cs.StreamDecoder.read(StreamDecoder.java:188)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/java.io.InputStreamReader.read(InputStreamReader.java:177)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/java.io.BufferedReader.fill(BufferedReader.java:162)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/java.io.BufferedReader.readLine(BufferedReader.java:329)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.base/java.io.BufferedReader.readLine(BufferedReader.java:396)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlin.io.LinesSequence$iterator$1.hasNext(ReadWrite.kt:79)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.flow.FlowKt__BuildersKt$asFlow$$inlined$unsafeFlow$5.collect(SafeCollector.common.kt:114)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.fastonetech.billing.sync.infra.command.CommandExecutorImpl$asyncRead$1.invokeSuspend(CommandExecutorImpl.kt:58)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:33)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:106)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.internal.LimitedDispatcher.run(LimitedDispatcher.kt:42)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:95)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:570)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:750)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:677)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:664)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面将解决该问题的原因和解决方案.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h2>
<blockquote>
<p>根本原因是<code>Process</code>对象被销毁后, 仍然在读取<code>Process</code>的<code>InputStream</code>和<code>ErrorStream</code>.<br>
有的时候命令执行会比较快这个时候<code>InputStream</code>和<code>ErrorStream</code>还没读完.</p>
</blockquote>
<p>我们调用<code>process.destroy()</code>前只判断了<code>process.exitValue()</code>是否为<code>0</code>, 没有判断<code>InputStream</code>和<code>ErrorStream</code>是否读完.<br>
这会导致销毁<code>Process</code>对象并导致<code>InputStream</code>和<code>ErrorStream</code>被关闭从而抛出<code>Stream Closed</code>异常.<br></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<blockquote>
<p>在<code>finally</code>块中等待<code>InputStream</code>和<code>ErrorStream</code>的读取操作完成后再销毁<code>Process</code>对象.</p>
</blockquote>
<p>修改后的代码如下:</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">asyncReadStdOut</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isActive </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> asyncReadStderr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isActive </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAlive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="备注">备注<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine#%E5%A4%87%E6%B3%A8" class="hash-link" aria-label="备注的直接链接" title="备注的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stream-closed异常测试">Stream Closed异常测试<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine#stream-closed%E5%BC%82%E5%B8%B8%E6%B5%8B%E8%AF%95" class="hash-link" aria-label="Stream Closed异常测试的直接链接" title="Stream Closed异常测试的直接链接">​</a></h3>
<p>下面的代码是用来复现<code>Stream Closed</code>异常的测试代码:</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runBlocking </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> executor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CommandExecutorImpl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">..</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">CoroutineScope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Dispatchers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CommandExecutionOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					command </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">listOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"echo"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal singleline string" style="color:#e3116c">"1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">awaitAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么不使用processwaitfor方法替代delay500方法">为什么不使用<code>Process.waitFor()</code>方法替代<code>delay(500)</code>方法<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E4%BD%BF%E7%94%A8processwaitfor%E6%96%B9%E6%B3%95%E6%9B%BF%E4%BB%A3delay500%E6%96%B9%E6%B3%95" class="hash-link" aria-label="为什么不使用processwaitfor方法替代delay500方法的直接链接" title="为什么不使用processwaitfor方法替代delay500方法的直接链接">​</a></h3>
<p>因为<code>waitFor</code>方法比较重量级会阻塞当前线程, 而我们的解决方案是协程目的是为了不阻塞当前线程, 所以才会采用<code>delay</code>方法.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/05/fix-stream-closed-exception-in-command-line-invocation-in-kotlin-coroutine#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://kotlinlang.org/docs/coroutines-guide.html" target="_blank" rel="noopener noreferrer">Coroutines guide</a></li>
<li><a href="https://kotlinlang.org/docs/cancellation-and-timeouts.html#run-non-cancellable-block" target="_blank" rel="noopener noreferrer">Run non-cancellable block</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="kotlin" term="kotlin"/>
        <category label="coroutines" term="coroutines"/>
        <category label="command-line" term="command-line"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[为Docusaurus中的Blog启用评论功能]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus"/>
        <updated>2023-04-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[最近想在Docusaurus中启用评论功能, 但是官方并没有提供这个功能, 所以只能自己动手了.]]></summary>
        <content type="html"><![CDATA[<p>最近想在<code>Docusaurus</code>中启用评论功能, 但是官方并没有提供这个功能, 所以只能自己动手了.<br></p>
<p>目前的解决方案是通过<code>Giscus</code>来实现, 它是一个基于<code>Github</code>的<code>Discussions</code>的评论系统实现的.<br>
<code>Discussions</code>需要依赖<code>Github</code>账号来进行评论, 所以后续需要一个公共的仓库来存放评论数据.<br>
如果你的博客是私有项目, 可以考虑创建一个新的公共的仓库用于存放评论数据, 这样可以确保原来的项目还可以为私有的.<br></p>
<p>以下内容会假设你拥有<code>Github</code>相关知识<br></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置giscus">配置<code>Giscus</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E9%85%8D%E7%BD%AEgiscus" class="hash-link" aria-label="配置giscus的直接链接" title="配置giscus的直接链接">​</a></h2>
<p>进入<a href="https://giscus.app/" target="_blank" rel="noopener noreferrer">Giscus</a>官网浏览文档, 然后根据文档中的要求进行配置.<br>
主要有以下几个步骤:</p>
<ul>
<li>准备一个公共的仓库
<br>该仓库主要用于存放评论数据, 如果你的博客是私有项目可以考虑创建一个公共的仓库用于存放评论数据</li>
<li>为公共的仓库启用<code>Github Discussions</code>,
参考<a href="https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/enabling-or-disabling-github-discussions-for-a-repository" target="_blank" rel="noopener noreferrer">Enabling or disabling GitHub Discussions for a repository</a></li>
<li>安装<a href="https://github.com/apps/giscus" target="_blank" rel="noopener noreferrer">giscus-github-app</a>并配置可以访问哪些仓库,
安装页面完成后可以在应用页面中可以找到<code>Configure</code>按钮, 点击该按钮进入配置页面</li>
</ul>
<p>以上是大致的配置步骤, 还有一些细节可以在刚才的官网页面中查看具体的配置说明. 例如:<br></p>
<ul>
<li><code>Docusaurus</code>博客的评论到<code>Discussion</code>中的映射关系</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证配置">验证配置<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="验证配置的直接链接" title="验证配置的直接链接">​</a></h2>
<p>这些配置做好之后, 你需要对你的配置进行验证, 以确保你的配置是正确的.<br></p>
<p><a href="https://giscus.app/" target="_blank" rel="noopener noreferrer">giscus</a>页面下的<code>Repository</code>提供了一个可以验证你的<code>repo</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="获取参数">获取参数<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0" class="hash-link" aria-label="获取参数的直接链接" title="获取参数的直接链接">​</a></h2>
<p>为了后续在<code>Docusaurus</code>中启用评论功能, 还需要获取一些参数, 这些参数后续会在<code>Docusaurus</code>中使用.<br></p>
<p><a href="https://giscus.app/" target="_blank" rel="noopener noreferrer">giscus</a>页面下的<code>Enable giscus</code>会根据你的配置生成一段代码, 该代码包含了你需要的参数.<br>
它看起来像这样:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">https://giscus.app/client.js</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-repo</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">[ENTER REPO HERE]</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-repo-id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">[ENTER REPO ID HERE]</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-category</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">[ENTER CATEGORY NAME HERE]</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-category-id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">[ENTER CATEGORY ID HERE]</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-mapping</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">pathname</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-strict</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-reactions-enabled</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">1</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-emit-metadata</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-input-position</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">bottom</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-theme</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">preferred_color_scheme</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">data-lang</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">en</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">crossorigin</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">anonymous</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">async</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装giscus">安装<code>Giscus</code><a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E5%AE%89%E8%A3%85giscus" class="hash-link" aria-label="安装giscus的直接链接" title="安装giscus的直接链接">​</a></h2>
<p><code>Giscus</code>组件是一个<code>React</code>组件, 用于在<code>Docusaurus</code>中启用评论功能.<br>
我们需要在项目中安装<code>Giscus</code>组件</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm install --save @giscus/react</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="组件扩展">组件扩展<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E7%BB%84%E4%BB%B6%E6%89%A9%E5%B1%95" class="hash-link" aria-label="组件扩展的直接链接" title="组件扩展的直接链接">​</a></h2>
<p><code>Docusaurus</code>中提供了<a href="https://docusaurus.io/docs/swizzling" target="_blank" rel="noopener noreferrer">Swizzling</a>功能, 可以对<code>Docusaurus</code>
中的组件进行扩展并增加新的功能.<br>
<code>BlogPostItem</code>是<code>Docusaurus</code>中用于展示博客文章的组件, 该组件位于<code>@theme-original/BlogPostItem</code>中.<br>
为了给在<code>Docusaurus</code>中启用评论功能, 需要对<code>BlogPostItem</code>进行扩展.<br></p>
<p>执行<code>swizzle</code>命令创建<code>BlogPostItem</code>组件</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm run swizzle @docusaurus/theme-classic BlogPostItem -- --wrap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该命令执行完成后<code>src/theme/BlogPostItem/index.js</code>文件会被创建<br></p>
<p>接下来对该文件进行编辑<br></p>
<blockquote>
<p>注意: 该文件中的<code>Giscus</code>组件的xxx参数需要根据你的配置进行修改, 配置的参数在上一节中已经介绍过了</p>
</blockquote>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">src/theme/BlogPostItem/index.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'react'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">BlogPostItem</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@theme-original/BlogPostItem'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Giscus</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"@giscus/react"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports">useBlogPost</span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@docusaurus/theme-common/internal'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports">useColorMode</span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@docusaurus/theme-common'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports">useDocusaurusContext</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@docusaurus/useDocusaurusContext'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">BlogPostItemWrapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">i18n</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">defaultLocale</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> localeConfigs</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useDocusaurusContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">colorMode</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useColorMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isBlogPostPage</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useBlogPost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">BlogPostItem</span><span class="token tag" style="color:#00009f"> </span><span class="token tag spread punctuation" style="color:#393A34">{</span><span class="token tag spread operator" style="color:#393A34">...</span><span class="token tag spread" style="color:#00009f">props</span><span class="token tag spread punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isBlogPostPage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Giscus</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">repo</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">repoId</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">category</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">categoryId</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">mapping</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">strict</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">reactionsEnabled</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">emitMetadata</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">inputPosition</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">theme</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">colorMode</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">lang</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">defaultLocale</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">crossorigin</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">anonymous</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">term</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">Welcome to @giscus/react component!</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">loading</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">lazy</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">                </span><span class="token tag attr-name" style="color:#00a4db">async</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">            </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="最终效果">最终效果<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E6%9C%80%E7%BB%88%E6%95%88%E6%9E%9C" class="hash-link" aria-label="最终效果的直接链接" title="最终效果的直接链接">​</a></h2>
<p>最终效果如下图所示:</p>
<p><img decoding="async" loading="lazy" alt="enable-comment-in-docusaurus.png" src="https://www.geek66.cyou/zh-CN/assets/images/enable-comment-in-docusaurus-8038867947841e387691a062cc401be6.png" width="2559" height="1371" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/04/04/enable-comment-in-docusaurus#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://giscus.app/" target="_blank" rel="noopener noreferrer">Giscus官网</a></li>
<li><a href="https://github.com/apps/giscus" target="_blank" rel="noopener noreferrer">Giscus的github-app</a></li>
<li><a href="https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/enabling-or-disabling-github-discussions-for-a-repository" target="_blank" rel="noopener noreferrer">启用Github中的Discussions</a></li>
<li><a href="https://github.com/facebook/docusaurus/issues/7759" target="_blank" rel="noopener noreferrer">关于useBlogPost函数的github-issue</a></li>
<li><a href="https://docusaurus.io/docs/swizzling" target="_blank" rel="noopener noreferrer">Swizzling的相关介绍</a></li>
<li><a href="https://www.wjwei.blog/docs/Potpourri/giscus-docusaurus" target="_blank" rel="noopener noreferrer">在Docusaurus上配置Giscus评论系统</a></li>
<li><a href="https://m19v.github.io/blog/how-to-add-giscus-to-docusaurus" target="_blank" rel="noopener noreferrer">How to add Giscus comments to Docusaurus</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="docusaurus" term="docusaurus"/>
        <category label="giscus" term="giscus"/>
        <category label="github" term="github"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Gitlab中常见的标签]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/03/31/common-tags-in-gitlab</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/03/31/common-tags-in-gitlab"/>
        <updated>2023-03-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Gitlab中的标签是一个非常有用的功能, 该功能可以帮助我们更好的管理ISSUE.]]></summary>
        <content type="html"><![CDATA[<p><code>Gitlab</code>中的标签是一个非常有用的功能, 该功能可以帮助我们更好的管理<code>ISSUE</code>.<br>
下面介绍一下<code>Gitlab</code>中常见的标签的定义和其使用希望能够对你有所帮助.<br></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="标签的定义">标签的定义<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/31/common-tags-in-gitlab#%E6%A0%87%E7%AD%BE%E7%9A%84%E5%AE%9A%E4%B9%89" class="hash-link" aria-label="标签的定义的直接链接" title="标签的定义的直接链接">​</a></h2>
<p>下面介绍常见的一些标签的定义, 以便我们更好的使用.</p>
<!-- -->
<table><thead><tr><th align="center">名称</th><th align="center">颜色</th><th align="center">16进制代码</th><th align="center">描述</th><th align="center">使用时机</th></tr></thead><tbody><tr><td align="center"><span style="font-size:1rem;color:white;background:#FF0000;border-radius:22px;padding:4px 12px">Bug</span></td><td align="center" style="white-space:nowrap">红</td><td align="center"><strong>#FF0000</strong></td><td align="center">错误或需修复</td><td align="center">发现/报告 一个问题</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#808080;border-radius:22px;padding:4px 12px">Duplicate</span></td><td align="center" style="white-space:nowrap">灰</td><td align="center"><strong>#808080</strong></td><td align="center">重复的issue</td><td align="center">发现/报告 一个已经存在的问题</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#0000FF;border-radius:22px;padding:4px 12px">Feature</span></td><td align="center" style="white-space:nowrap">蓝</td><td align="center"><strong>#0000FF</strong></td><td align="center">新功能或需求</td><td align="center">提出/实现 一个新的功能或需求</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#00FF00;border-radius:22px;padding:4px 12px">Fixed</span></td><td align="center" style="white-space:nowrap">绿</td><td align="center"><strong>#00FF00</strong></td><td align="center">已修复或完成</td><td align="center">解决/完成 一个问题或任务</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#000000;border-radius:22px;padding:4px 12px">Invalid</span></td><td align="center" style="white-space:nowrap">黑</td><td align="center"><strong>#000000</strong></td><td align="center">无效或不合理</td><td align="center">发现/报告 一个不符合 规范/逻辑 的问题</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#800080;border-radius:22px;padding:4px 12px">Proposal</span></td><td align="center" style="white-space:nowrap">紫</td><td align="center"><strong>#800080</strong></td><td align="center">建议或想法</td><td align="center">提出/讨论 一个建议或想法</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#FFA500;border-radius:22px;padding:4px 12px">Task</span></td><td align="center" style="white-space:nowrap">橙</td><td align="center"><strong>#FFA500</strong></td><td align="center">任务或工作</td><td align="center">分配/执行 一个任务或工作</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#A52A2A;border-radius:22px;padding:4px 12px">Wontfix</span></td><td align="center" style="white-space:nowrap">棕</td><td align="center"><strong>#A52A2A</strong></td><td align="center">不会或不需修复</td><td align="center">决定不处理/忽略 一个问题</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#FFC0CB;border-radius:22px;padding:4px 12px">Improvement</span></td><td align="center" style="white-space:nowrap">粉</td><td align="center"><strong>#FFC0CB</strong></td><td align="center">改进或优化</td><td align="center">对一个功能或需求进行 改进/优化</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#ADD8E6;border-radius:22px;padding:4px 12px">Enhancement</span></td><td align="center" style="white-space:nowrap">淡蓝</td><td align="center"><strong>#ADD8E6</strong></td><td align="center">增强或扩展</td><td align="center">对一个功能或需求进行 增强/扩展</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#FFFF00;border-radius:22px;padding:4px 12px">Question</span></td><td align="center" style="white-space:nowrap">黄</td><td align="center"><strong>#FFFF00</strong></td><td align="center">疑问或询问</td><td align="center">对一个问题或任务有 疑问/询问</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#FF00FF;border-radius:22px;padding:4px 12px">Help wanted</span></td><td align="center" style="white-space:nowrap">紫红</td><td align="center"><strong>#FF00FF</strong></td><td align="center">需要帮助或协作</td><td align="center">需要其他人的 帮助/协作</td></tr><tr><td align="center"><span style="font-size:1rem;color:white;background:#90EE90;border-radius:22px;padding:4px 12px">Documentation</span></td><td align="center" style="white-space:nowrap">浅绿</td><td align="center"><strong>#90EE90</strong></td><td align="center">需要或涉及文档</td><td align="center">涉及文档的 编写/更新</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>Improvement和Enhancement之间的区别<br></p><p>Improvement: <br>
表示对一个不太好的事物进行改善或提高, 使其达到更好的水平或状态.<br>
We need to improve our product quality to meet the customer’s needs.(我们需要改善我们的产品质量, 以满足客户的需求.)<br></p><p>Enhancement: <br>
表示对一个已经很好的事物进行增强或扩展, 使其更加优秀或有吸引力.<br>
The new feature of this phone enhanced its competitiveness.(这款手机的新功能增强了它的竞争力.)<br></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/31/common-tags-in-gitlab#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://about.gitlab.com/handbook/marketing/project-management-guidelines/labels/" target="_blank" rel="noopener noreferrer">Labels project management guidelines | GitLab</a>
<br>这是Gitlab关于标签项目管理指南的页面, 包含了一些创建和使用标签的规范和建议.</li>
<li><a href="https://about.gitlab.com/handbook/support/support-ops/training/gitlab-labeling.html" target="_blank" rel="noopener noreferrer">GitLab Labeling Training | GitLab</a>
<br>这是Gitlab关于标签培训的页面, 包含了一些标签的最佳实践和示例.</li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="gitlab" term="gitlab"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[解决elm依赖下载失败的问题]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed"/>
        <updated>2023-03-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[最近在本地构建open-radiant项目.]]></summary>
        <content type="html"><![CDATA[<p>最近在本地构建<a href="https://github.com/JetBrains/open-radiant" target="_blank" rel="noopener noreferrer">open-radiant</a>项目.<br>
该项目是<code>JetBrains</code>开源的一个项目, 用于生成AI艺术图片, 在线演示地址为: <a href="https://code2art.jetbrains.com/" target="_blank" rel="noopener noreferrer">code2art</a><br>
在构建的过程中遇到了一些问题.<br>
其中的一个问题是当执行<code>elm make</code>时依赖下载失败, 日志如下:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Starting downloads...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/json 1.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm-community/list-extra 8.2.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/random 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/file 1.0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/virtual-dom 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/parser 1.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● rtfeldman/elm-iso8601-date-strings 1.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/url 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm-community/random-extra 3.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm-explorations/webgl 1.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ● elm/core 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm/http 2.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ owanturist/elm-union-find 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm/bytes 1.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm/svg 1.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ avh4/elm-color 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm/time 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm-community/json-extra 4.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ fredcy/elm-parseint 2.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ noahzgordon/elm-color-extra 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm/html 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm/browser 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ newlandsvalley/elm-binary-base64 1.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✗ elm-community/easing-functions 2.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dependency problem!           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- PROBLEM DOWNLOADING PACKAGE -------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I was trying to download the source code for avh4/elm-color 1.0.0, so I tried to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    https://github.com/avh4/elm-color/zipball/1.0.0/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">But my HTTP library is giving me the following error message:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConnectionTimeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you somewhere with a slow internet connection? Or no internet? Does the link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I am trying to fetch work in your browser? Maybe the site is down? Does your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internet connection have a firewall that blocks certain domains? It is usually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">something like that!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h2>
<p>这个问题的原因是<code>elm</code>的依赖在国内访问会比较慢, 甚至会出现下载失败的情况.<br>
为了解决这个问题, 我们可以手动下载依赖包, 然后放到<code>elm</code>的依赖目录下, 以后再执行<code>elm make</code>时就不会再去下载依赖了.<br></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<p>案例:</p>
<ul>
<li>项目依赖<code>avh4/elm-color 1.0.0</code></li>
<li>elm版本为<code>0.19.0</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="确定依赖的目录">确定依赖的目录<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed#%E7%A1%AE%E5%AE%9A%E4%BE%9D%E8%B5%96%E7%9A%84%E7%9B%AE%E5%BD%95" class="hash-link" aria-label="确定依赖的目录的直接链接" title="确定依赖的目录的直接链接">​</a></h3>
<p><code>elm</code>的依赖目录在<code>~/.elm</code>下, 依赖包的目录结构可以通过<code>tree</code>命令查看:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tree ~/.elm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── 0.19.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── avh4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── elm-color</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Debugger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Platform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── File</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 2.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── regex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── svg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Svg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── virtual-dom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;             └── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;                 └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── elm-community</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── easing-functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 2.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── json-extra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 4.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             ├── Decode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;             └── Encode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── list-extra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 8.2.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── random-extra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 3.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;             └── Random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── elm-explorations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; ├── linear-algebra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp; └── 1.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;     └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; │&nbsp;&nbsp;         └── Math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── webgl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 1.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;             ├── Elm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;             │&nbsp;&nbsp; └── Kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;             └── WebGL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;                 └── Settings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── fredcy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── elm-parseint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 2.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── newlandsvalley</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── elm-binary-base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 1.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── noahzgordon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── elm-color-extra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;             └── Color</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── owanturist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp; └── elm-union-find</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;     └── 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │&nbsp;&nbsp;         └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── rtfeldman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            └── elm-iso8601-date-strings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                └── 1.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">135 directories</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过命令执行结果可以看到其目录结构大致如下</p>
<ul>
<li>第一级目录为<code>packages</code></li>
<li>第二级目录为<code>group</code>(以<code>avh4/elm-color 1.0.0</code>为例, <code>group</code>为<code>avh4</code>)</li>
<li>第三级目录为<code>artifact</code>(以<code>avh4/elm-color 1.0.0</code>为例, <code>artifact</code>为<code>elm-color</code>)</li>
<li>第四级目录为<code>version</code>(以<code>avh4/elm-color 1.0.0</code>为例, <code>version</code>为<code>1.0.0</code>)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载依赖">下载依赖<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed#%E4%B8%8B%E8%BD%BD%E4%BE%9D%E8%B5%96" class="hash-link" aria-label="下载依赖的直接链接" title="下载依赖的直接链接">​</a></h3>
<p>以<code>avh4/elm-color 1.0.0</code>为例, 我们通过<code>https://github.com/avh4/elm-color/zipball/1.0.0/</code> 链接下载对应的安装包</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装">安装<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed#%E5%AE%89%E8%A3%85" class="hash-link" aria-label="安装的直接链接" title="安装的直接链接">​</a></h3>
<p>将该安装包里的文件解压到<code>~/.elm/0.19.0/package/avh4/elm-color/1.0.0</code>目录下</p>
<blockquote>
<p>注意:
安装包打开会有一个单独的目录, 这个目录里面的文件是我们需要解压的文件</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-elm-package-download-failed#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://github.com/JetBrains/open-radiant" target="_blank" rel="noopener noreferrer">open-radiant</a></li>
<li><a href="https://code2art.jetbrains.com/" target="_blank" rel="noopener noreferrer">code2art</a></li>
<li><a href="https://elm-lang.org/" target="_blank" rel="noopener noreferrer">elm</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="elm" term="elm"/>
        <category label="jetbrains" term="jetbrains"/>
        <category label="code2art" term="code2art"/>
        <category label="open-radiant" term="open-radiant"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[node.js v17及以上版本使用openssl v3.0引发的哈希算法错误及其解决方法]]></title>
        <id>https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-node-v17-upwards-openssl-hash-error</id>
        <link href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-node-v17-upwards-openssl-hash-error"/>
        <updated>2023-03-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[最近在本地构建open-radiant项目.]]></summary>
        <content type="html"><![CDATA[<p>最近在本地构建<a href="https://github.com/JetBrains/open-radiant" target="_blank" rel="noopener noreferrer">open-radiant</a>项目.<br>
该项目是<code>JetBrains</code>开源的一个项目, 用于生成AI艺术图片, 在线演示地址为: <a href="https://code2art.jetbrains.com/" target="_blank" rel="noopener noreferrer">code2art</a><br>
在构建的过程中遇到了一些问题.<br></p>
<p>其中的一个问题是当执行<code>npm start</code>时报错, 相关错误信息如下:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; jb-animation-generator@1.0.0 start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; ./node_modules/.bin/webpack-dev-server --mode=development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ℹ ｢wds｣: Project is running at http://localhost:8080/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ℹ ｢wds｣: webpack output is served from /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ℹ ｢wds｣: Content not from webpack is served from /home/orange/Documents/Project/Github/open-radiant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node:internal/crypto/hash:71</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this[kHandle] = new _Hash(algorithm, xofLen);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: error:0308010C:digital envelope routines::unsupported</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at new Hash (node:internal/crypto/hash:71:19)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at Object.createHash (node:crypto:133:10)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at module.exports (/home/orange/Documents/Project/Github/open-radiant/node_modules/webpack/lib/util/createHash.js:135:53)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at NormalModule._initBuildHash (/home/orange/Documents/Project/Github/open-radiant/node_modules/webpack/lib/NormalModule.js:417:16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at handleParseError (/home/orange/Documents/Project/Github/open-radiant/node_modules/webpack/lib/NormalModule.js:471:10)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at /home/orange/Documents/Project/Github/open-radiant/node_modules/webpack/lib/NormalModule.js:503:5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at /home/orange/Documents/Project/Github/open-radiant/node_modules/webpack/lib/NormalModule.js:358:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at /home/orange/Documents/Project/Github/open-radiant/node_modules/loader-runner/lib/LoaderRunner.js:373:3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at iterateNormalLoaders (/home/orange/Documents/Project/Github/open-radiant/node_modules/loader-runner/lib/LoaderRunner.js:214:10)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at Array.&lt;anonymous&gt; (/home/orange/Documents/Project/Github/open-radiant/node_modules/loader-runner/lib/LoaderRunner.js:205:4) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opensslErrorStack: [ 'error:03000086:digital envelope routines::initialization error' ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  library: 'digital envelope routines',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reason: 'unsupported',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  code: 'ERR_OSSL_EVP_UNSUPPORTED'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node.js v18.12.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题原因">问题原因<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-node-v17-upwards-openssl-hash-error#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="问题原因的直接链接" title="问题原因的直接链接">​</a></h2>
<p>经过网上的一番搜索, 发现这个问题是由于<code>node.js</code>的版本升级到<code>v17</code>及以上版本, 而<code>openssl</code>的版本升级到<code>v3.0</code>引起的.<br></p>
<p><code>openssl</code>是一个开源的安全套接字层密码库, 用于提供加密和认证服务.<br>
<code>node.js</code>在<code>v17</code>及以上版本中使用了<code>openssl</code>的<code>v3.0</code>版本, 该版本中移除了一些哈希算法, 导致在使用这些算法时报错.<br></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-node-v17-upwards-openssl-hash-error#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<p>这个问题的解决解决方案有以下几种:</p>
<ul>
<li>降低<code>node.js</code>的版本到v16及以下版本</li>
<li><code>npm start</code>之前先执行<code>export NODE_OPTIONS=--openssl-legacy-provider</code>
<br>通过该环境变量可以启用<code>openssl</code>的<code>legacy provider</code>，支持一些旧的哈希算法.<br></li>
<li>升级相关依赖包到最新版本，可能会修复这个问题.<br></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="https://www.geek66.cyou/zh-CN/blog/2023/03/30/fix-node-v17-upwards-openssl-hash-error#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://stackoverflow.com/questions/69692842/error-message-error0308010cdigital-envelope-routinesunsupported" target="_blank" rel="noopener noreferrer">Stack Overflow上关于这个问题的讨论</a></li>
<li><a href="https://nodejs.org/api/crypto.html#crypto_openssl_3_0" target="_blank" rel="noopener noreferrer">Node.js官方文档中关于OpenSSL 3.0的说明</a></li>
<li><a href="https://github.com/nodejs/help/issues/4021" target="_blank" rel="noopener noreferrer">GitHub上关于这个问题的报告</a></li>
</ul>]]></content>
        <author>
            <name>Xiangcheng Kuo</name>
            <uri>https://github.com/orange-guo</uri>
        </author>
        <category label="problem-solving" term="problem-solving"/>
        <category label="nodejs" term="nodejs"/>
        <category label="openssl" term="openssl"/>
        <category label="compatibility" term="compatibility"/>
        <category label="jetbrains" term="jetbrains"/>
        <category label="code2art" term="code2art"/>
        <category label="open-radiant" term="open-radiant"/>
    </entry>
</feed>