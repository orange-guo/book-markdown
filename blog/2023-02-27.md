---
authors: [xiangcheng.kuo]
tags: [spring, graalvm]
---

# 将`springboot`应用版本升级为3以及构建`native`镜像的过程中遇到的问题

## 问题列表

### 代码中的`javax`包导入切换为`jakarta`

springboot3的`javax`依赖变为了`jakarta`, 代码中需要将包导入从`javax`切换到`jakarta`.

### querydsl依赖变更

将`querydsl`相关依赖的`classfiier`设置为`jakarta`.

```kotlin title="build.kts"
implementation("com.querydsl:querydsl-jpa:5.0.0:jakarta")
kapt("com.querydsl:querydsl-apt:5.0.0:jakarta")
```

关于这个问题的更多信息请参阅[Are there plans to support SpringBoot3.0(Java17)?](https://github.com/querydsl/querydsl/issues/3296)

### 移除`spring-native`依赖, 因为已被`spring-core`提供的`aot`功能取代

`spring-native`已被`spring-core`提供的`aot`功能取代, 所以不需要引入老的`spring-native`依赖.<br/>
在github[spring-native](https://github.com/spring-attic/spring-native)的主页上有如下说明
> This project is now superseded by Spring Boot 3+ official native support, see the related reference documentation for
> more details.

新的`aot`
功能的文档可以参阅[GraalVM Native Image Support](https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html)<br/>

其内部工作原理主要通过`ReflectiveProcessor`和`RuntimeHintsRegistrar`用来帮助生成反射提示, 并在`graalvm`
编译期间使用.<br/>

### `@RegisterReflectionForBinding`无法集成`querysdl`生成的`Q`类

由于`querydsl`生成的Q类不能放在`@RegisterReflectionForBinding`上(因为编译优先级原因),
则需要重新实现`@RegisterReflectionForBinding`的具体实现逻辑.<br/>
主要是继承`ReflectiveProcessor`并配合`BindingReflectionHintsRegistrar`.<br/>
参考代码:<br/>

```kotlin
class ReflectiveProcessorImpl : ReflectiveProcessor {

	override fun registerReflectionHints(hints: ReflectionHints, element: AnnotatedElement) {
		val function = BindingReflectionHintsRegistrar()::registerReflectionHints.partially1(hints)
		function(
			arrayOf(
				Page::class.java,
				ResponseResult::class.java,
				SignInRequest::class.java,
				SignInResponse::class.java
			)
		)
	}

}
```

### 升级`graalvm`版本

如果使用的`graalvm`版本过于老, 则会出现如下类似的错误

```
GraalVM version 22.3 is required but 22.0 has been detected, please upgrade.
```

为了解决这个问题需要将`graalvm`升级到最新版本

### `paketo`依赖下载失败

通过`./gradlew bootBuildImage`构建镜像时, 输出以下错误

```log
unable to copy from https://github.com/bell-sw/Liberica/releases/download/17.0.5+8/bellsoft-jre17.0.5+8-linux-amd64.tar.gz to /tmp/ee56d911dd187d4965fe2d5280e17b76253eb40eb4e5c8582a17cd46ea0168b1/bellsoft-jre17.0.5+8-linux-amd64.tar.gz
[creator]     stream error: stream ID 1; PROTOCOL_ERROR; received from peer
```

这个问题的原因是因为`paketo`的进行构建过程中会下载一些依赖, 但是这些依赖在国外, 下载速度会变慢, 甚至会下载失败.<br/>
关于这个问题的详细信息可以参考[Override paketo-buildpacks download URIs](https://github.com/paketo-buildpacks/bellsoft-liberica/issues/7).<br/>
以下是解决方案参考:
使用[binding-tool](https://github.com/dmikusa/binding-tool)工具生成dependency-mapping到bindings并映射到builder容器中

## 备注

### `gradle`中`native`相关命令

```bash
./gradlew nativeCompile
./gradlew bootBuildImage
./build/native/nativeCompile/fastone-auditing
```

### `gradle`中的`BootBuildImage`配置参考

```kotlin title="build.kts"
tasks.withType<BootBuildImage> {
	// https://docs.spring.io/spring-boot/docs/3.0.0/gradle-plugin/reference/htmlsingle/#build-image.examples.caches
	buildCache {
		volume {
			name.set("cache-${rootProject.name}.build")
		}
	}
	launchCache {
		volume {
			name.set("cache-${rootProject.name}.launch")
		}
	}
	publish.set(true)
	docker {
		publishRegistry {
			username.set(System.getenv("HARBOR_USERNAME"))
			password.set(System.getenv("HARBOR_PASSWORD"))
		}
	}

	val labels = System.getenv("LABELS")?.replace(",", " ")

	// https://github.com/paketo-buildpacks/image-labels
	mapOf("SERVICE_BINDING_ROOT" to "/bindings").plus(
		when (labels) {
			null -> emptyMap()
			else -> mapOf("BP_IMAGE_LABELS" to labels)
		}
	).let { environment.set(it) }
	bindings.set(listOf("${project.projectDir}/bindings:/bindings"))
	val formatter = DateTimeFormatter.ofPattern("yyyyMMdd-HHmmss")
	imageName.set("hub.fastonetech.com/infra/${project.name}:${formatter.format(ZonedDateTime.now(ZoneId.of("UTC")))}")
}
```

- [native-image.developing-your-first-application](https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html#native-image.developing-your-first-application.native-build-tools.gradle)
- [build-image.examples](https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/htmlsingle/#build-image.examples)

### `binding-tool`使用方式参考

```bash
./bt dm -t buildpack.toml
./bt dm -b paketo-buildpacks/bellsoft-liberica
./bt dm -b paketo-buildpacks/syft
```

- [buildpack.toml](https://raw.githubusercontent.com/paketo-buildpacks/bellsoft-liberica/main/buildpack.toml)