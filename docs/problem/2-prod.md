# 生产遇到的问题

## 全芯智造无法添加用户

### 现象

无法在portal中创建用户, ldap出错

### 原因

/fastone-prometheus目录空间不足

### 解决方案

删除占用空间的文件

### 备注

#### 排查过程

> *定义:*<br/>
> x: 表示该步骤执行结果不符合期望的结果<br/>
> v: 表示该步骤执行结果输出了有用的信息

##### 1. 尝试本地复现(x)

尝试从客户环境中dump出ldif文件并ldapadd到本地环境中, 并手动创建组和用户, 发现问题未复现

##### 2. 进入客户环境查看当时失败时的日志(x)

通过docker-logs查看日志发现日志比较多(容器每秒很多行日志) & 无法dump出日志到指定文件（docker logs fastone-ldap >
log.log）
便进入/var/lib/docker里找容器日志, 由于容器里最多只能保存十分钟的日志故无法找到失败时的相关日志

##### 3. 尝试让客户手动复现问题, 并通过日志定位问题(x)

后续尝试让客户手动复现问题， 由于没有在10分钟内没有成功登录到堡垒机环境中导致错过日志定位

##### 4. 猜测是ldap自身问题, 并非java框架的问题(v)

@dong.zhang 指出可能是客户环境的ldap问题
便尝试使用ldapadd命令复现出问题，并写了脚本能够在add完之后得到当前时间以便于定位日志进行排查
根据执行完脚本后输出的时间去容器日志里过滤最后发现日志中存在io err
![1667314884936.jpg](/img/1667314884936.jpg)

##### 5. 猜测是/fasstone磁盘空间不足(x)

cd /fastone/services/ldap/data目录尝试写入文件发现可以写入, 并且df -h /fastone显示空间大小正常

##### 6. 猜测是nfsv3locked问题(x)

猜测是nfsv3问题, 后面经 @ricker 指引出目前ldap是存在于本地磁盘中
于是便docker inspect fastone-ldap发现目录映射并不是/fastone而是/fastone-prometheus
![1667314884947.png](/img/1667314884947.png)

##### 7. 猜测是/fastone-prometheus空间不足 (v)

使用df -h /fastone-promethues 发现空间不足
![1667314884956.jpg](/img/1667314884956.jpg)
使用du -h 查看空间占用发现prometheus占用空间较大, 在删除prometheus数据文件后再次执行ldapadd成功
![1667314884964.jpg](/img/1667314884964.jpg)

## 生产环境运营平台未出现客户月度账单

### 现象

在运营平台客户账单未导入

### 原因

目前`mgmt-api`有bug由于该客户有两个环境只会导入一个环境的账单数据(国内), 导致海外环境的账单没有出现

### 解决方案

修改`mgmt-api`的bug

### 备注

## CC浙大VNC无法连接

### 现象

客户远程连接无法使用, 但我们自己的可以, 通过后台查看`remote-access`服务发现数据库链接耗尽

### 原因

客户ssh存在问题导致`remote-access`服务尝试执行命令时卡死, 并且执行期间是处在事务内部导致数据库连接耗尽(
如果卡死的数量接近数据库连接最大数量)

### 解决方案

- SSH增加超时机制, 避免资源被耗尽, 同时增加RalteLimit

### 备注

## 生产环境mgmt-api服务报错statusId字段不存在

### 现象

在运营平台FCC-E账单页点击国内和海外的账单，报未知错误<br/>
通过查看日志发现报错提示找不到bill表的status_id字段

### 原因

数据库flyway定义的schema版本和生产代码所使用的schema版本不一致导致异常发生

- 生产数据库: 1.0.51
- 生产代码: 1.0.48
  因为之前发布错误(基于21.11)导致数据库版本到达了1.0.51<br/>
  后来又发了一版(基于21.09)导致数据库数据结构和使用中存在差异

### 解决方案

1. 回滚schema
2. 代码升级schema, 且相关Entity字段的映射也同步更新
   考虑到回滚schema比较麻烦且需要经过验证, 经过分析后决定升级schema到最新代码

### 备注


## 生产环境聚合桶没及时同步国内客户数据

### 现象

账单数据没有出现

### 原因

global没有为国内的billing-sync开放IP白名单(该服务需要获取deployments)

### 解决方案

开放白名单

### 备注